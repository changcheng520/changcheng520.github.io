<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>CentOS 8.0  LEMP环境的性能与安全优化指南2022版 - 没位道</title><meta name="description" content="在上一篇文章《从零部署Linux服务器完全指南2022版(CentOS 8+Nginx+PHP)》的基础上，我们完成了LEMP环境的部署，接下去为了提高网站运行的稳定性，我们将对其进行进一步的性能与安全优化。"/><meta property="og:title" content="CentOS 8.0  LEMP环境的性能与安全优化指南2022版 - 没位道"/><meta property="og:description" content="在上一篇文章《从零部署Linux服务器完全指南2022版(CentOS 8+Nginx+PHP)》的基础上，我们完成了LEMP环境的部署，接下去为了提高网站运行的稳定性，我们将对其进行进一步的性能与安全优化。"/><meta property="og:url" content="https://www.c945.com/article/performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html"/><meta property="og:image" content="https://www.c945.com/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg"/><meta name="next-head-count" content="6"/><link rel="icon" href="/assets/images/favicon/favicon-32x32.png" type="image/x-icon"/><link rel="shortcut icon" href="/assets/images/favicon/favicon-32x32.png" sizes="32x32"/><link rel="apple-touch-icon" href="/assets/images/favicon/apple-touch-icon-57x57.png"/><link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicon/apple-touch-icon-72x72.png"/><link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicon/apple-touch-icon-114x114.png"/><link rel="preload" href="/_next/static/css/ab4d44a60d7a5fe0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ab4d44a60d7a5fe0.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a80a7b96b8396f08.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a80a7b96b8396f08.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-803820e42116e4e4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5816f20eb504df5c.js" defer=""></script><script src="/_next/static/chunks/424-328589773c4cbd07.js" defer=""></script><script src="/_next/static/chunks/669-26e51e3e61a246e5.js" defer=""></script><script src="/_next/static/chunks/355-8e546d82173371b2.js" defer=""></script><script src="/_next/static/chunks/782-9ef19db02a591dc2.js" defer=""></script><script src="/_next/static/chunks/pages/article/%5Bid%5D-eb52e5d17e91782f.js" defer=""></script><script src="/_next/static/or2KW4Yk6XXL-Cofu9R5v/_buildManifest.js" defer=""></script><script src="/_next/static/or2KW4Yk6XXL-Cofu9R5v/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="main-wrapper"><div class="loading-spirit loaded"><i class="fa fa-spinner fa-spin fa-3x fa-fw margin-bottom"></i></div><div class="styles_back-to-top__xN2cj"><button type="button" class=""><svg width="40" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300.222 300.221"><g><path d="M299.201,93.188c-14.688-25.704-29.988-50.184-43.452-76.5c-3.06-6.12-12.852-4.284-14.688,1.836 c-7.345,26.316-16.524,58.14-15.301,85.068c0,6.12,6.732,7.344,10.404,4.284c0.612,0.612,1.836,0.612,3.061,0.612 c6.731-0.612,13.464-1.836,19.584-2.448c22.031,55.692,39.779,152.388-44.677,158.508c-8.567,0.612-15.3-1.224-20.195-4.896 c11.628-9.792,21.42-22.031,26.315-36.107c6.732-18.36-6.731-57.528-31.824-46.512c-20.195,9.18-24.479,45.899-20.808,64.26 c1.224,5.508,3.06,10.403,4.896,14.688c-1.837,1.225-3.061,1.836-4.896,3.061c-15.912,9.18-34.883,13.464-53.244,12.852 c-13.464-0.612-21.42-7.956-26.316-17.748c16.524-8.567,29.988-22.032,33.66-36.107c7.344-29.988-31.212-49.572-47.124-20.196 c-7.344,13.464-8.568,32.436-4.284,48.96c-0.612,0.612-1.836,0.612-2.448,1.224c-52.632,21.42-68.544-45.288-38.556-78.336 c2.448-3.06-0.612-7.956-4.284-5.508c-36.108,25.704-33.048,80.784,8.568,98.532c11.016,4.896,26.928,3.06,41.616-1.836 c6.732,13.464,17.748,23.868,33.66,25.704c23.868,3.06,51.408-3.673,73.44-17.137c12.852,10.404,31.212,12.853,50.184,8.568 c80.172-15.912,65.484-113.832,42.228-171.972c6.12-0.612,11.629-0.612,17.748-0.612 C297.978,105.427,302.261,98.083,299.201,93.188z M83.166,240.067c-0.612-4.283-1.224-8.567-1.224-12.852 c0-6.732,1.224-13.464,3.06-19.584c4.284-14.688,29.988-9.792,22.032,9.792C102.138,226.603,92.958,234.559,83.166,240.067z M180.473,229.664c0-8.568,3.673-39.168,16.524-39.78c9.792-0.612,9.792,26.316,9.18,30.6c-2.447,11.629-11.016,21.42-21.42,28.765 C181.697,243.127,180.473,236.395,180.473,229.664z M252.077,43.615c8.568,15.912,17.748,31.212,26.928,46.512 c-12.852,1.836-25.704,4.284-37.943,7.344C246.569,80.947,249.018,61.975,252.077,43.615z"></path></g></svg></button></div><header class="header axil-header axil-header--page header-style-1 splash-header-style "><div class="axil-mainmenu "><div class="container"><div class="header-navbar"><div class="header-logo"><a href="/default.html"><img src="/assets/images/logo-light.png" alt="logo" width="150"/><img class="sticky-logo" src="/assets/images/logo-dark.png" alt="logo" width="100"/></a></div><div class="header-main-nav"><nav class="mainmenu-nav"><ul class="mainmenu"><li class="nav-item"><a class="nav-link active" href="/articles/page/1.html"><i class="fa fa-solid fa-quote-left"></i>文章</a></li><li class="nav-item"><a class="nav-link" href="/works.html"><i class="fa fa-solid fa-briefcase"></i>作品</a></li><li class="nav-item"><a class="nav-link" href="/products.html"><i class="fa fa-solid fa-code"></i>产品</a></li><li class="nav-item"><a class="nav-link" href="/about.html"><i class="fa fa-duotone fa-user"></i>关于</a></li><li class="nav-item"><a class="nav-link" href="/links.html"><i class="fa fa-solid fa-link"></i>友情链接</a></li></ul></nav></div><div class="header-action"><ul class="list-unstyled"><li class="mobile-menu-btn sidemenu-btn d-lg-none d-block"><button class="btn-wrap"><span></span><span></span><span></span></button></li></ul></div></div></div></div><div class="mobilemenu-popup"><div class="mobilemenu-inner"><div class="mobilemenu-header"><div class="mobile-nav-logo"><a href="/"><img src="/assets/images/logo-dark.png" alt="logo" width="100"/></a></div><button class="mobile-menu-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="10"><path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"></path></svg></button></div><div class="mobilemenu-body"><nav class="mainmenu-nav"><ul class="mainmenu"><li class="nav-item"><a class="nav-link active" href="/articles/page/1.html"><i class="fa fa-solid fa-quote-left"></i>文章</a></li><li class="nav-item"><a class="nav-link" href="/works.html"><i class="fa fa-solid fa-briefcase"></i>作品</a></li><li class="nav-item"><a class="nav-link" href="/products.html"><i class="fa fa-solid fa-code"></i>产品</a></li><li class="nav-item"><a class="nav-link" href="/about.html"><i class="fa fa-duotone fa-user"></i>关于</a></li><li class="nav-item"><a class="nav-link" href="/links.html"><i class="fa fa-solid fa-link"></i>友情链接</a></li></ul></nav></div></div></div></header><div class="section call-to-action-area splash-call-to-action call-to-action-area--page"><ul class="list-unstyled shape-group-9"><li class="shape shape-1"><img src="/assets/images/others/bubble-12.png" alt="Comments"/></li><li class="shape shape-2"><img src="/assets/images/others/bubble-16.png" alt="Comments"/></li><li class="shape shape-3"><img src="/assets/images/others/bubble-13.png" alt="Comments"/></li><li class="shape shape-4"><img src="/assets/images/others/bubble-14.png" alt="Comments"/></li><li class="shape shape-5"><img src="/assets/images/others/bubble-16.png" alt="Comments"/></li><li class="shape shape-6"><img src="/assets/images/others/bubble-15.png" alt="Comments"/></li><li class="shape shape-7"><img src="/assets/images/others/bubble-16.png" alt="Comments"/></li></ul></div><nav id="onepagenav" class="service-scroll-nav navbar app-primary-nav app-primary-nav--page"><div class="container"><ul class="nav nav-pills"><li class="nav-item"><a class="nav-link current" href="/articles/page/1.html"><i class="fa fa-solid fa-quote-left"></i>文章</a></li><li class="nav-item"><a class="nav-link" href="/works.html"><i class="fa fa-solid fa-briefcase"></i>作品</a></li><li class="nav-item"><a class="nav-link" href="/products.html"><i class="fa fa-solid fa-code"></i>产品</a></li><li class="nav-item"><a class="nav-link" href="/about.html"><i class="fa fa-duotone fa-user"></i>关于</a></li><li class="nav-item"><a class="nav-link" href="/links.html"><i class="fa fa-solid fa-link"></i>友情链接</a></li></ul></div></nav><section class="section section-padding blog-post-content-show"><div class="container"><div class="row"><div class="blog-post__title"><div class="container"><div class="row"><div class="col-md-8 offset-md-2 col-sm-10 offset-sm-1 text-center"><h1 class="h2">CentOS 8.0  LEMP环境的性能与安全优化指南2022版</h1><div class="blog-post__author">April<!-- --> <!-- -->21<!-- -->, <!-- -->2022<span><em>  by   </em></span><span class="h6">Chuckie Chang<!-- --> | 分类至:  <a title="开发趣味" href="/articles/sort/%e5%bc%80%e5%8f%91%e8%b6%a3%e5%91%b3/page/1.html"><span>开发趣味</span></a></span></div></div></div></div><div class="elementor-image-holder text-center"><img src="/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg" alt="CentOS 8.0  LEMP环境的性能与安全优化指南2022版"/></div></div></div></div><div class="container type-blog-output"><div class="row"><div class="col-md-8 offset-md-2"><div><p>在上一篇文章<a href="https://matrixflip.com/api/the-complete-guide-to-deploying-a-linux-server-from-scratch-version-2022-for-centos8-nginx-php/" target="_blank" rel="noopener">《从零部署Linux服务器完全指南2022版(CentOS 8+Nginx+PHP)》</a>的基础上，我们完成了LEMP环境的部署，接下去为了提高网站运行的稳定性，我们将对其进行进一步的性能与安全优化。</p>
<p>整体步骤分为下面的八个：</p>
<blockquote><p><strong>（一）Mariadb和Nginx服务断开后自动重启<br />
（二）PHP配置修改<br />
（三）启用GZIP压缩<br />
（四）创建交换空间swap space<br />
（五）进一步优化Mariadb<br />
（六）静态文件缓存和PHP缓存<br />
（七）配置Redis缓存mysql数据<br />
（八）学会检查内存占用的程序<br />
（可选）配置DNS到cloudflare提高性能和安全性</strong></p></blockquote>
<p>这一部分操作顺序不一定要由上至下，但是建议您按照由上至下的顺序循序渐进。</p>
<h3>（一）Mariadb和Nginx服务断开后自动重启</h3>
<p><span style="color: #ff0000;">推荐使用SH脚本执行</span><br />
也可以编辑.sh脚本，并保存，记录.sh文件所在路径【一定确保.sh脚本可用，可以尝试在编辑完成.sh文件后，直接./tomcat.sh 执行脚本文件，查看是否可以正常执行】</p>
<pre class="codePre brush: js;">mkdir /usr/share/nginx/sh
sudo vi /usr/share/nginx/sh/test.sh</pre>
<p>测试脚本：</p>
<pre class="codePre brush: js;">#!/bin/bash
if [[ "$(systemctl status nginx.service)" =~ "active" ]]
then
    echo "process is running"
else
    echo "process is not running"
fi</pre>
<p>给予权限和执行</p>
<pre class="codePre brush: js;">chmod +x /usr/share/nginx/sh/test.sh
/usr/share/nginx/sh/test.sh</pre>
<p>然后删除</p>
<pre class="codePre brush: js;">rm -rf /usr/share/nginx/sh/test.sh</pre>
<p>先查看服务器的时间，根据其时间推断中国区域的时间</p>
<pre class="codePre brush: js;">date</pre>
<p>或</p>
<pre class="codePre brush: js;">timedatectl</pre>
<p>始终确保使用 crontab -e 编辑您的 crontab。检测cron定时服务是否自启用</p>
<pre class="codePre brush: js;">systemctl is-enabled crond.service</pre>
<p>如果未启用，则开启cron自启用</p>
<pre class="codePre brush: js;">systemctl enable crond.service</pre>
<p>如果已经启用，想要cron关闭自启动</p>
<pre class="codePre brush: js;">systemctl disable crond.service</pre>
<p>查看cron服务的启动状态[只有cron的状态是active running的，才表示cron服务是启动的]</p>
<pre class="codePre brush: js;">systemctl status crond.service</pre>
<p>查看增加的定时脚本</p>
<pre class="codePre brush: js;">crontab -l</pre>
<p>直接编辑定时脚本</p>
<pre class="codePre brush: js;">crontab -e</pre>
<h4>添加自动重启mariadb服务</h4>
<blockquote><p>新增一个sh脚本，当数据库服务出问题时自动启动mariadb服务</p>
<pre class="codePre brush: js;">sudo vi /usr/share/nginx/sh/mysql-check.sh</pre>
<p>脚本如下：</p>
<pre class="codePre brush: js;">#!/bin/bash
if [[ ! "$(systemctl is-active mariadb.service )" =~ "active" ]]
then
systemctl start mariadb.service
fi</pre>
<p>保存文件后，修改其权限</p>
<pre class="codePre brush: js;">chmod u+r+x /usr/share/nginx/sh/mysql-check.sh</pre>
<p>直接运行，检测是否能执行（不报Permission denied错即可）</p>
<pre class="codePre brush: js;">/usr/share/nginx/sh/mysql-check.sh</pre>
<p>添加到自动任务列表,每 15 分钟运行一次命令,</p>
<pre class="codePre brush: js;">crontab -e</pre>
<p>脚本如下：</p>
<pre class="codePre brush: js;">*/15 * * * * /usr/share/nginx/sh/mysql-check.sh</pre>
</blockquote>
<h4>添加自动重启nginx服务</h4>
<blockquote><p>为了更好地解决信号量过载造成的http连接无法建立，导致服务无法启动这问题，增加一个自动清除信号量的脚本：</p>
<p>新增一个sh脚本，当数据库服务出问题时自动启动mariadb服务</p>
<pre class="codePre brush: js;">sudo vi /usr/share/nginx/sh/server-check.sh</pre>
<p>脚本如下：</p>
<pre class="codePre brush: js;">#!/bin/bash
if [[ ! "$(systemctl status nginx.service)" =~ "active" ]]
then
ipcrm -a
systemctl restart nginx.service
fi</pre>
<p>保存文件后，修改其权限</p>
<pre class="codePre brush: js;">chmod u+r+x /usr/share/nginx/sh/server-check.sh</pre>
<p>直接运行，检测是否能执行（不报Permission denied错即可）</p>
<pre class="codePre brush: js;">/usr/share/nginx/sh/server-check.sh</pre>
<p>添加到自动任务列表,每 30 分钟运行一次命令,</p>
<pre class="codePre brush: js;">crontab -e</pre>
<p>脚本如下：</p>
<pre class="codePre brush: js;">*/30 * * * * /usr/share/nginx/sh/server-check.sh</pre>
</blockquote>
<p>查看脚本</p>
<pre class="codePre brush: js;">crontab -l</pre>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart crond.service</pre>
<h3>（二） PHP配置修改</h3>
<h4>Step1：配置php.ini</h4>
<p>先备份一个原配置：</p>
<pre class="codePre brush: js;">cp /etc/php.ini /etc/php.ini.bak</pre>
<p>修改配置(使用/和n查询字段)</p>
<pre class="codePre brush: js;">vi /etc/php.ini</pre>
<p>支持php短标签(如果配置里没有或者被注释了就增加)</p>
<pre class="codePre brush: js;">short_open_tag = On   #原数值Off</pre>
<p>修改上传文件限制为100M(方便上传较大的还原数据)</p>
<pre class="codePre brush: js;">upload_max_filesize = 100M   #原数值2M</pre>
<p>&nbsp;</p>
<p>下面这两行要修改一下(如果配置里没有或者被注释了就增加)，否则WP一直是8M</p>
<pre class="codePre brush: js;">post_max_size = 200M   #原数值8M
max_execution_time = 300   #原数值30</pre>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart php-fpm nginx</pre>
<p>&nbsp;</p>
<blockquote><p>注意：Nginx中设置过server { client_max_body_size 100M; } 属性才能生效</p></blockquote>
<p>&nbsp;</p>
<h4>Step2：配置 php-fpm</h4>
<p>配置php-fpm的session权限，否则会影响WordPress的功能</p>
<pre class="codePre brush: js;">vi /etc/php-fpm.d/www.conf</pre>
<p>查找php_value[session.save_path]字符，找到它储存session的位置为<span style="background-color: #ffff00;"> /var/lib/php/session</span></p>
<pre class="codePre brush: js;">chmod -R 777 /var/lib/php/session
chmod -R 777 /var/lib/php/opcache
chmod -R 777 /var/lib/php/wsdlcache</pre>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart php-fpm nginx</pre>
<h3>（三）启用GZIP压缩</h3>
<p>修改Nginx配置，让https支持php等常用配置，代码如下，修改443端口(非www部分)</p>
<pre class="codePre brush: js;">vi /etc/nginx/conf.d/default.conf</pre>
<p>加入以下代码：</p>
<pre class="codePre brush: js;">     # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;</pre>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart nginx</pre>
<h3>（四）创建交换空间swap space</h3>
<p>首先使用<span style="background-color: #ffff00;">df -h</span>和<span style="background-color: #ffff00;">free -m</span>命令查看内存使用情况和swap的大小</p>
<p><img src="/static-remote/files/902a9270fb2a13e3a1ec264a-matrixflipcomapiwpcontentuploadsafbaeaecajpg.jpg" alt="" /></p>
<p>创建Swap文件（这里创建了4G的交换空间）</p>
<pre class="codePre brush: js;">sudo fallocate -l 4G /swapfile</pre>
<p>检查是否创建OK</p>
<pre class="codePre brush: js;">ls -lh /swapfile</pre>
<p>启用Swap文件</p>
<pre class="codePre brush: js;">sudo chmod 600 /swapfile
ls -lh /swapfile</pre>
<p>既然我们的交换文件更安全，我们可以通过输入以下内容告诉我们的系统设置交换空间以供使用：</p>
<pre class="codePre brush: js;">sudo mkswap /swapfile
sudo swapon /swapfile</pre>
<p>为了验证程序是否成功，我们可以检查我们的系统现在是否报告交换空间：</p>
<pre class="codePre brush: js;">swapon -s
free -m</pre>
<p>使交换文件永久化</p>
<pre class="codePre brush: js;">sudo vi /etc/fstab</pre>
<p>最底部添加下面代码让系统使用并自动挂载</p>
<pre class="codePre brush: js;">/swapfile swap swap defaults 0 0</pre>
<p>重新查看</p>
<pre class="codePre brush: js;">free -m</pre>
<p><img src="/static-remote/files/6bb42232e3c3509309361997-matrixflipcomapiwpcontentuploadsbbecjpg.jpg" alt="" /></p>
<blockquote><p><strong>(可选，目前未设置）</strong></p>
<p>调整 Swappiness 值。Swappiness 是一个 Linux 内核属性，它定义了系统使用交换的频率空间。 Swappiness 可以有一个介于 0 和 100 之间的值。低值将使内核尽量避免交换，而较高的值将使内核更积极地使用交换空间。CentOS 8 上的默认 swappiness 值为 30。您可以查看当前的 swappiness</p>
<pre class="codePre brush: js;">cat /proc/sys/vm/swappiness</pre>
<p>虽然 30 的 swappiness 值对于桌面和开发机器是可以的，但对于生产服务器，您可能需要设置一个较低的值。更改参数，要使此参数在重新启动后保持不变：</p>
<pre class="codePre brush: js;">vi /etc/sysctl.conf
vm.swappiness=10</pre>
</blockquote>
<hr />
<blockquote><p><strong>(可选，目前未设置）</strong></p>
<p>要停用和删除交换文件，请按照下列步骤操作：</p>
<p>通过键入以下内容停用交换空间：</p>
<pre class="codePre brush: js;">sudo swapoff -v /swapfile</pre>
<p>从 /etc/fstab 中删除交换条目 /swapfile swap swap defaults 0 0</p>
<p>删除文件</p>
<pre class="codePre brush: js;">sudo rm /swapfile</pre>
</blockquote>
<h3></h3>
<h3>（五）进一步优化Mariadb</h3>
<p>模拟和解决可能遇见的问题如下：</p>
<blockquote><p>(1) Error establishing a database connection<br />
(2) Warning: mysqli_real_connect(): (HY000/2002): Connection refused in<br />
(3) Deprecated: mysql_connect(): The mysql extension is deprecated and will be removed in the future: use mysqli or PDO instead in …<br />
(4) Warning: mysql_connect(): Connection refused…</p></blockquote>
<h4>Step1: 修改最大连接数</h4>
<p>避免mysqli_real_connect():Connection refused in类似错误，可能是由于连接数超过了被拒绝</p>
<p>检查mariadb的版本信息</p>
<pre class="codePre brush: js;">rpm -qa | grep mariadb</pre>
<p>查看mariadb的最大连接数为默认151(输入密码)</p>
<pre class="codePre brush: js;">rpm -qa | grep mariadb</pre>
<p>检查mysql版本</p>
<pre class="codePre brush: js;">rpm -qa |grep mysql</pre>
<p>先备份一个配置文件，修改配置文件，增加最大连接数</p>
<pre class="codePre brush: js;">sudo cp /etc/my.cnf /etc/my.cnf.bak
vi /etc/my.cnf</pre>
<p>在调整为 MySQL 分配多少内存时，只需要更新分配给innodb_buffer_pool_size的值。 不要更新其他参数，添加3行代码：</p>
<blockquote><p>①对于具有小型 RAM (&lt;= 1GB) 的系统,最好使用 MySQL 默认配置值 128MB 作为 InnoDB 缓冲池大小。<br />
②适用于具有中型 RAM (1GB – 32GB) 的系统,我们可以使用以下粗略的启发式方法计算操作系统需求：256MB + 256 * log2（以 GB 为单位的 RAM 大小）</p></blockquote>
<pre class="codePre brush: js;">[mysqld]
max_connections=1000
innodb_buffer_pool_size = 128M</pre>
<p><img src="/static-remote/files/efb4376be12632d62452950e-matrixflipcomapiwpcontentuploadsefbbedejpg.jpg" alt="" /></p>
<p>重启mariadb服务，再次查看mariadb数据库最大连接数，可以看到最大连接数是214，并非我们设置的1000。这是由于mariadb有默认打开文件数限制。可以通过配置/usr/lib/systemd/system/mariadb.service来调大打开文件数目。</p>
<pre class="codePre brush: js;">systemctl restart mariadb.service</pre>
<p>先备份一个原配置：</p>
<pre class="codePre brush: js;">cp /usr/lib/systemd/system/mariadb.service /usr/lib/systemd/system/mariadb.service.bak</pre>
<p>配置文件</p>
<pre class="codePre brush: js;">vi /usr/lib/systemd/system/mariadb.service</pre>
<p>[Service]新添加两行如下参数：</p>
<pre class="codePre brush: js;">LimitNOFILE=10000
LimitNPROC=10000</pre>
<p>重新加载系统服务，并重启mariadb服务, 再次查看mariadb数据库最大连接数，可以看到最大连接数已经是1000</p>
<pre class="codePre brush: js;">systemctl --system daemon-reload  
systemctl restart mariadb.service</pre>
<p>再次查看mariadb的最大连接数</p>
<pre class="codePre brush: js;">mysqladmin -uroot -p variables |grep max_connections</pre>
<p><img src="/static-remote/files/0718ff54cde627b357608df7-matrixflipcomapiwpcontentuploadsffcdebdfjpg.jpg" alt="" /></p>
<p>查看mysql的建立的连接数</p>
<pre class="codePre brush: js;">netstat -n | awk '/^tcp/ {++state[$NF]} END {for(key in state) print key,"\t",state[key]}'</pre>
<p>&nbsp;</p>
<blockquote><p>进入mysql终端，此时输入密码</p>
<pre class="codePre brush: js;" style="line-height: 1.42857;">mysql -u root -p</pre>
<p>进入mysql终端后的命令</p>
<pre class="codePre brush: js;" style="line-height: 1.42857;">select version();   #查看当前mysql版本
show status like 'Threads%';    #查看当前mysql连接数
show variables like '%max_connections%';   #查看当前mysql最大连接数
show variables like 'log_%';  #是否启用错误日志
show master status; #当前日志是否存在
QUIT; #退出</pre>
</blockquote>
<p>&nbsp;</p>
<h4>Step2: Mariadb关闭后自动重连接</h4>
<p>查看mariadb的日志</p>
<pre class="codePre brush: js;">tail /var/log/mariadb/mariadb.log</pre>
<p>崩溃后自动重启</p>
<pre class="codePre brush: js;">vi /etc/systemd/system/multi-user.target.wants/mariadb.service</pre>
<p>在[Service]下面加入以下行（如果已经存在则修改值，默认值为<span style="color: #ff0000;">on-abort</span>中止）</p>
<pre class="codePre brush: js;">Restart=always</pre>
<p>重新加载系统守护程序</p>
<pre class="codePre brush: js;">sudo systemctl daemon-reload
sudo systemctl restart mariadb.service</pre>
<p>重启服务器,稍等十几秒后恢复</p>
<pre class="codePre brush: js;">sudo reboot</pre>
<p>模拟数据库崩溃的效果，查找进程看到类似ID后可以kill掉</p>
<pre class="codePre brush: js;">ps -ef | grep mysql</pre>
<p>强制终止进程（如果/etc/systemd/system/multi-user.target.wants/mariadb.service文件修改成功，择数据库被kill后，会立刻重启恢复）</p>
<pre class="codePre brush: js;">sudo kill -9 1179</pre>
<p><img src="/static-remote/files/5ad1f21e3652b91cd741ab73-matrixflipcomapiwpcontentuploadsadfebcdabjpg.jpg" alt="" /></p>
<h4>Step3: Mysql进程崩溃后自动重启</h4>
<p>需要配置/etc/inittab文件，首先备份一个，编辑此文件一定要非常小心</p>
<pre class="codePre brush: js;">sudo cp /etc/inittab /etc/inittab.bak
vi /etc/inittab</pre>
<p>结尾处增加一行，在/ etc / inittab文件中放置一个命令，以在mysqld_safe进程崩溃时重新生成mysqld_safe进程。 它有四个字段，每个字段与冒号<span style="background-color: #ffff00;">（:)</span>分隔开</p>
<pre class="codePre brush: js;">ms:2345:respawn:/bin/sh /usr/bin/mysqld_safe</pre>
<p>保存后重启服务</p>
<pre class="codePre brush: js;">systemctl restart mariadb.service</pre>
<p>重启服务器,稍等十几秒后恢复</p>
<pre class="codePre brush: js;">sudo reboot</pre>
<p>查看服务状态</p>
<pre class="codePre brush: js;">sudo service mariadb status</pre>
<h3>（六）静态文件缓存和PHP缓存</h3>
<p><span style="color: #ff0000;"><strong>特别注意：</strong>不要使用 /usr/share/nginx/目录作为缓存文件夹，因为如果不执行sudo setenforce 0，系统将无法自己创建缓存文件，绕过SELinux是很危险的，使用/var/lib/nginx/文件夹，默认被SELinux允许</span></p>
<h4>Step1: PHP缓存设置</h4>
<p>先配置nginx的根文件，配置PHP的缓存</p>
<pre class="codePre brush: js;">vi /etc/nginx/nginx.conf</pre>
<p>在<span style="background-color: #ffff00;">http { ... }</span> 中加入代码，使用/var/lib/nginx/cache作为php的缓存文件夹</p>
<pre class="codePre brush: js;">    # Enable PHP cache
    fastcgi_cache_path /var/lib/nginx/cache levels=1:2 keys_zone=MYAPP:100m inactive=60m max_size=40m;
    fastcgi_cache_key "$scheme$request_method$host$request_uri";</pre>
<p>接着修改server配置文件</p>
<pre class="codePre brush: js;">vi /etc/nginx/conf.d/default.conf</pre>
<p><span style="background-color: #ffff00;">server { location ~ \.php$ { ... } }</span>中加入代码配置PHP缓存，60m是60分钟：</p>
<pre class="codePre brush: js;">        # Enable PHP cache
        fastcgi_cache MYAPP;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;
        fastcgi_cache_min_uses 1;
        fastcgi_cache_lock on;
        add_header X-FastCGI-Cache $upstream_cache_status;</pre>
<p>生成缓存文件夹，给权限</p>
<pre class="codePre brush: js;">mkdir /var/lib/nginx/cache</pre>
<p><span style="color: #ff0000;">必须给予权限才能从客户端访问缓存:</span></p>
<pre class="codePre brush: js;">sudo chown -R myftp1:www-data /var/lib/nginx/cache</pre>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart nginx php-fpm</pre>
<p>新建一个PHP缓存测试文件</p>
<pre class="codePre brush: js;">vi /usr/share/nginx/html/wordpress/time.php</pre>
<p>脚本如下：</p>
<pre class="codePre brush: js;">&lt;?php
echo time();
?&gt;</pre>
<p>测试缓存效果：</p>
<pre class="codePre brush: js;">curl -I https://yoursite.com/time.php</pre>
<p><strong>x-fastcgi-cache</strong> 的值出现<span style="background-color: #ffff00;">HIT</span>表示生效，而且time.php的时间数值不会变动</p>
<p><img src="/static-remote/files/108f763c025f5b53287fe939-matrixflipcomapiwpcontentuploadsfcfbfejpg.jpg" alt="" /></p>
<p>清除缓存：</p>
<pre class="codePre brush: js;">rm -rf /var/lib/nginx/cache/*</pre>
<h4>Step2: Nginx静态文件缓存设置</h4>
<p>先配置nginx的根文件，配置静态文件缓存的Expires map</p>
<pre class="codePre brush: js;">vi /etc/nginx/nginx.conf</pre>
<p>在<span style="background-color: #ffff00;">http { ... }</span> 中加入代码（缓存某些目录下的文件30天，HTML文件不会被缓存）</p>
<pre class="codePre brush: js;">    # Expires map
    map $sent_http_content_type $expires {
        default                    off;
        text/html                  epoch;
        text/css                   30d;
        application/javascript     30d;
        ~image/                    30d;
        ~images/                   30d;
        ~videos/                   30d;
        ~models/                   30d;
        ~fonts/                    30d;
        ~font/                     30d;
        ~wp-content/uploads/       30d; 
    }</pre>
<p>接着修改server配置文件</p>
<pre class="codePre brush: js;">vi /etc/nginx/conf.d/default.conf</pre>
<p><span style="background-color: #ffff00;">server { ... }</span>中加入代码配置静态文件缓存：</p>
<pre class="codePre brush: js;">    # Expires static files
    expires $expires;</pre>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart nginx</pre>
<p>测试缓存效果【注意：此缓存是储存在客户端(浏览器)上的配置，不是直接从服务端读取】：</p>
<pre class="codePre brush: js;">curl -I /static-remote/files/xxxxxxxxx-yoursitecomxxxxxxxxxjpg.jpg
</pre>
<p><img src="/static-remote/files/98786e1222cbd526f68bdbf1-matrixflipcomapiwpcontentuploadsecbdfbdbfjpg.jpg" alt="" /></p>
<p><img src="/static-remote/files/df7a94714ae20101dfccb7ea-matrixflipcomapiwpcontentuploadsdfaaedfccbeajpg.jpg" alt="" /></p>
<h3>（七）配置Redis缓存mysql数据</h3>
<p>安装redis（目前版本5.0.3）</p>
<pre class="codePre brush: js;">dnf install redis -y</pre>
<p>启动</p>
<pre class="codePre brush: js;">systemctl start redis
systemctl enable redis</pre>
<p>查看状态</p>
<pre class="codePre brush: js;">systemctl status redis</pre>
<p>检查端口</p>
<pre class="codePre brush: js;">ss -ant | grep 6379  或者  semanage port -l | grep "redis"</pre>
<p>测试redis连接</p>
<pre class="codePre brush: js;">redis-cli</pre>
<p><strong>输入：<span style="background-color: #ffff00;">ping<br />
</span>输入：<span style="background-color: #ffff00;">INFO server</span></strong></p>
<p><img src="/static-remote/files/77c66b8fda72b84189cede2c-matrixflipcomapiwpcontentuploadscbfdabcedecjpg.jpg" alt="" /></p>
<p>配置redis,先备份一个</p>
<pre class="codePre brush: js;">cp /etc/redis.conf /etc/redis.conf.bak</pre>
<p>配置</p>
<pre class="codePre brush: js;">vi /etc/redis.conf</pre>
<p>结尾处添加：</p>
<pre class="codePre brush: js;">maxmemory 128mb
maxmemory-policy allkeys-lru</pre>
<p>&nbsp;</p>
<blockquote><p><strong>（可选）</strong></p>
<p>默认情况下，redis-cli 允许您在 Raedis shell 中运行任何命令。 因此，使用密码保护 Redis shell 是一个好主意。 您可以启用密码验证：</p>
<p>找到下面这行：</p>
<pre class="codePre brush: js;" style="line-height: 1.42857;"># requirepass foobared</pre>
<p>&nbsp;</p>
<p>改成密码即可：</p>
<pre class="codePre brush: js;" style="line-height: 1.42857;">requirepass yourpassword</pre>
</blockquote>
<p>重启</p>
<pre class="codePre brush: js;">systemctl restart redis</pre>
<p>WordPress安装插件来启用和检查redis使用情况</p>
<p><strong>Redis Object Cache</strong>用来启用redis</p>
<p><img src="/static-remote/files/6f92ed6bb2e8d8bd2ee362c8-matrixflipcomapiwpcontentuploadsfedbbedbdeecjpg.jpg" alt="" /></p>
<p><strong>Query Monitor</strong>用来检测mysql链接情况，出现下图表示存在缓存（OK后卸载即可，使用一个插件就行）</p>
<p><img src="/static-remote/files/dbb5907316dd4ccdaf6cfc0d-matrixflipcomapiwpcontentuploadsdbbddccdafcfcdjpg.jpg" alt="" /></p>
<p>可以使用终端检查</p>
<pre class="codePre brush: js;">redis-cli monitor</pre>
<p>刷新网站出现</p>
<p><img src="/static-remote/files/6a7f44ef1037dab0b3dfc41e-matrixflipcomapiwpcontentuploadsafefdabbdfcejpg.jpg" alt="" /></p>
<p><span style="color: #ff0000;"><strong>注意：</strong>SELinux安全策略 （sudo setenforce 1）启动后redis连接将会失效，未来保障安全，我们不能关闭安全策略，所以暂时禁用redis。</span></p>
<h3>（八）学会检查内存占用的程序</h3>
<p>可以简单实用top命令，然后访问网站，就会动态出现内存占用的程序，学会分析他们</p>
<p><img src="/static-remote/files/d084ae19524ed0b082f53106-matrixflipcomapiwpcontentuploadsdaeedbfjpg.jpg" alt="" /></p>
<h3>（可选） 配置DNS到cloudflare提高性能和安全性</h3>
<p>首先注册Cloudflare账号，然后添加一个域名，登录你的域名注册商的后台，把DNS修改为<span style="background-color: #ffff00;">dax.ns.cloudflare.com</span> 和<span style="background-color: #ffff00;">sue.ns.cloudflare.com</span>即可，具体的设置可以参看Cloudflare官网</p>
<p><span style="color: #ff0000;"><strong>注意：</strong>Cloudflare不支持特殊端口号，如果网站使用了其它端口号挂载资源，需要使用Cloudflare Spectrum来支持其它端口号（付费服务）</span></p>
<h3>结语</h3>
<p>看到这了，差不多完整的一整套部署已经可以正常稳定（相对稳定，并不代表不会被攻击，或者使用的后台有漏洞，这些需要自己去注意）使用了。目前CentOS 8的生命周期已经结束，我们也可以在此基础上，继续升级到CentOS Stream 9，整体的搭建思路其实差不多，主要注意一些命令、安全机制的差异，之后如果我自己的某些站点启用了CentOS Stream 9的话，也会实战一下从零部署并发布相关文章，希望本文对你有帮助，感兴趣可以继续关注我，会不定期分享一些东西。：）</p>
</div><p>本文出自<a class="simple-btn" href="https://www.c945.com/article/performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html">没位道 - Chuckie Chang个人网站</a>，转载请保留出处，谢谢！<br/>文章采用<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC-BY-4.0"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAMAAABUFvrSAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAAEZ0FNQQAAsY58+1GTAAAAAXNSR0IB2cksfwAAAf5QTFRF////////////////8fHx7+/v6Ofn4+Pj4N/g39/f1tXV09bS0tXS0tXR0dTR0dTQ0NTQ0NPPz9PPztLOztHNzdHNzdHMz8/PzdDMzNDMzNDLzM/Ly8/Ly8/Ky87Kys3Jyc3Jyc3Iy8rLyMzIyMzHx8vHxsrGycjIxsrFxcnFyMfHxcnExMnExMjDw8jDxMfDw8fCwsfCwcXAwMXAwMW/wMS/v8S+v8O+vsO+vsK9vcK9vcK8v7+/vMG8vMG7vMC8u8C7u8C6ur+6ur+5ub65ub64uL23t7y2urm5tru1tbq0tLqztLmzs7iysrixtbW1srexsbewsLavsLWvr7Wur7SusLOvrrStrrOtr7KvrbOsrLKrr6+vq7GqrKurpqqmo6ijoqaho6Ghn6OenqCdn5+fnp2dn5aampiZlpmWlZmUmJaXk5iTkZSRkZORkY+Pj4+PiYyJjIqLjoeLh4aHhIaEhIWEgoWChIGCf4F+gICAfX98fH98fnt8en15eXx5eHV2dnN0dXJzcHJvcHBwbmxsaGVmY19hYGBgXV5dWldYUFFQUFBQQ0RDQEBAPj8+Pzs8Pzc5NTY1MjMxMjExMDAwMS0uLS0tKioqKSopKSkpKCkoKCgoKicnKCUmJCQkIx8gICAgHxscGxsbGRkZEBAQDg4ODQ4NDQwNAAAA4LK4NQAAAAN0Uk5TAAoO5yEBUwAAA+1JREFUeNq1lot3GkUUxlcviEDS7bYbKxC2oaWKSUmRpkkrSBvzIMGkJjGamoSobROtNqRVWyOppli0NBBSHxst+JiYUvr9l57dheVx8ESpncOeOfvbnW92vjv3DtyzeCqN44BIeCh02t/tcXdIDpvN4Tzs9nj9faHBcGR88u2Z2dm56H9vAIdIeCBwyudxOUWBb7FaW/YJYrvL4+sJDCjK0zOzc00pcwgPBE56j0kif3OzqCyiuHmDP+h0H/e/NhCOnJ+avjA7t55THuTWK+P2JOAwFDjpdduF2G7FoN1lwebq8gcGw2MTUzOf5IFsMpkF8le1UVf3JuAQOuV12/g0gEIqHgzGUwUA6RMvuI73hIZGxyc/fISMmYjInMEjddSlf0HA4bTvmF3RLcSNpLXFApA/YXP7+vqHIxM5pIgIUB4grwzKq2Rlo46YOjtNOgEHv0cS0oBsJr0ZZSAtOD3+wNDoGjKWsjBlsB6NruPnj4lWHj5OmHSSsdBFxhgbKRFFuPuoGANkI1Gt8vJBl7e3P/wAVTOakYtGc/iD3f8e8S+woBMzdbIf7iYYW9GIIuxx8rsoHKKaZixgl2/3+F8fQla5T0FdPmURjSL77W3GWMJkqRAyfMQ+J1pi2xpRhN1tN4E41bVF4Ibo9p0ZQJJUJzQvkopMkqgzASBhqRDDn+w3IhNjz6lEEe44sImCkSiYyWbjWneNiArYFA57e/sbCxOZEtuMbYzo5K1fgqrw87qwxBeVZQbVHZydV7uUsvjiPmdXz7lGVhCRYYksSrTul8nIxZeJFhirWOFoBa4RydgxB3cWZcjm+Z1F1YsWh8cf+lULnvbBeqhog21vI7Hw9V9lssTY6urv7NNK8OxWIKiMjGsCJbuDgNX2kj/0FTJUv90yRKbVh49XDNVkVVnAd4bKdttDePhBJUGS1Qny2UYdObKwYNFJjRXGQztxGbLSVawYfr/ZlC4FrxQ1PXhJFHmpq+fc8Jsf5AA5lZQrJedSfk+ibrc0CqRvt/ms2tEONoUOb+8b4bHJd75pqmy622KqF40S5NUzg6PjUzNNHCLg8Iqa0uZ/SunI+WaFu4+KlxsVoZjo6u7rD49NTF+Ya0oYtyThHiBXlSGzWjalL5/omAZwx7G/utAb4wXgR95+C08qjDXb/nt1RxP/4hX9HS0/oF0a0S4i1L1EtcJYcwiXqw/TmGC/UjWm9KMqldJ9zVQ1QBPGHUnkY+Xjf5kXpWofymWzeiqqmag8F1G9MH56z9l2gG+1Wlt5QWx/d6tmTJ0RZRuohtUtgdP51vWzksNud0hnr2/VxqHRF9d7XI5DA+H/+1/hM09J92+7pmyRGJsTpgAAAABJRU5ErkJggg==" alt="CC-BY-4.0"/> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p></div></div></div></section><section><div class="container"><div class="row"><div class="col-md-8 offset-md-2"><div class="blog-tags"><h6>关键词: </h6><a href="/articles/tag/index.html?page=1&amp;s=CentOS">CentOS</a><a href="/articles/tag/index.html?page=1&amp;s=%E5%AE%89%E5%85%A8">安全</a><a href="/articles/tag/index.html?page=1&amp;s=%E6%80%A7%E8%83%BD">性能</a><a href="/articles/tag/index.html?page=1&amp;s=%E6%9C%8D%E5%8A%A1%E5%99%A8">服务器</a></div></div></div></div></section><section><div class="container"><div class="row"><div class="col-md-8 offset-md-2"><div class="row justify-content-between pb-5"><div class="col text-start"><a class="simple-btn" href="/article/the-complete-guide-to-deploying-a-linux-server-from-scratch-version-2022-for-centos8-nginx-php.html"><i class="fas fa-long-arrow-alt-left"></i>  上一篇</a></div><div class="col text-end"><a class="simple-btn" href="/article/b214e53f0c655e422783718d.html">下一篇 <i class="fas fa-long-arrow-alt-right"></i></a></div></div><hr/><div class="text-center p-3"><a class="axil-btn btn-fill-primary" href="/article/[id]"><span>返回列表</span></a>  <a class="axil-btn btn-fill-secondary" data-title="CentOS 8.0  LEMP环境的性能与安全优化指南2022版" data-url="https://www.c945.com/article/performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html" data-pic="https://www.c945.com/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg" href="#" data-modal-width="600px" data-modal-height="300px"><svg viewBox="0 0 448 512"><path fill="#0d6efd" d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"></path></svg>分享</a><div class="styles_app-share-modal-box__9M8_R"><a href="#" class="styles_app-share-modal-box__close__gDukx"><svg xmlns="http://www.w3.org/2000/svg" width="20" viewBox="0 0 320 512"><path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"></path></svg></a><div class="styles_app-share-modal-box__content__7Z_58"><div><div class="styles_app-share__wrapper__xvEL0"><h3>分享给朋友!</h3><div><span data-network="true" data-title="CentOS 8.0  LEMP环境的性能与安全优化指南2022版" data-url="https://www.c945.com/article/performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html" data-pic="https://www.c945.com/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg" data-href="https://tool.oschina.net/action/qrcode/generate?data={u}&amp;output=image%2Fgif&amp;error=L&amp;type=0&amp;margin=0&amp;size=4&amp;1578559516540"><svg xmlns="http://www.w3.org/2000/svg" width="50" viewBox="0 0 576 512"><path fill="#0c7f3a" d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"></path></svg></span><em>微信</em></div><div><span data-network="true" data-title="CentOS 8.0  LEMP环境的性能与安全优化指南2022版" data-url="https://www.c945.com/article/performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html" data-pic="https://www.c945.com/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg" data-href="http://service.weibo.com/share/share.php?title={t}&amp;url={u}&amp;pic={p}"><svg xmlns="http://www.w3.org/2000/svg" width="50" viewBox="0 0 576 512"><path fill="#d90909" d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"></path></svg></span><em>微博</em></div></div></div></div></div></div></div></div></div></section><section class="pb--80 pb_lg--40 pb_md--20"><div class="container"><div class="row"><div class="col-md-8 offset-md-2"><div class="blog-comment-form"><h5>文章评论</h5><hr/><div id="app-remotecomment__comments"></div><div class="app-remotecomment__form"><form id="app-remotecomment-site"><div class="row"><div class="col-lg-6"><div class="form-group"><label>标题 (必填)</label><input type="text" name="title" id="title" class="form-control"/></div></div><div class="col-lg-6"><div class="form-group"><label>电子邮箱 (必填，不公开)</label><input type="email" name="email" id="email" class="form-control"/></div></div><div class="col-lg-12"><div class="form-group"><label>网址</label><input type="url" name="url" id="url" class="form-control" placeholder="https://"/></div></div><div class="col-lg-12"><div class="form-group mb--30"><label>内容</label><textarea id="content" name="content" class="form-control textarea" cols="30" rows="4"></textarea></div></div><div class="col-lg-4 app-remotecomment-captcha-section"><div class="form-group"><label>验证码</label><input type="text" id="captcha" name="captcha" class="form-control"/></div></div><div class="col-lg-8 app-remotecomment-captcha-section"><div class="form-group"><label> </label><div class="captcha-wrapper"><span id="uix-usercenter-refresh-session-captcha"></span></div></div></div><div class="col-lg-5"><div class="form-group"><button type="submit" class="axil-btn btn-fill-primary btn-fluid" name="submit-btn">提交</button></div><p class="status"></p></div></div><input type="hidden" name="toid" id="toid" value="1011005052999899579"/><input type="hidden" name="refer" id="refer" value="https://www.c945.com/article/performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html"/><input type="hidden" name="app-remotecomment-site-security" id="app-remotecomment-site-security"/></form></div></div></div></div></div></section><section class="section section-padding-2 bg-color-dark pb--80 pb_lg--40"><div class="container"><div class="row"><div class="col-md-8 offset-md-2 footer-menu-link footer-menu-link--list"><h5 class="title-white">相关文章推荐</h5><ul></ul></div></div></div></section><footer class="footer-area splash-footer splash-footer--page"><div class="container"><div class="footer-bottom"><div class="row align-items-center"><div class="col-md-12 text-center"><div class="footer-copyright"><p class="copyright-text">&copy; 2010-2023 <a href="/">没位道</a> All Rights Reserved. 本站基于JAMstack技术构建<br />若未特别说明，本站所有内容均遵循<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC-BY-4.0">CC-BY-4.0 国际许可协议</a></p><script id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>
                            if (typeof(LA) !== 'undefined') LA.init({id: "JdyfUJi3RdCZVi9F",ck: "JdyfUJi3RdCZVi9F"});
                        </script></div></div></div></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"currentData":{"ID":903333,"author":"1","author_nickname":"wpuser","author_display_name":"Chuckie Chang","author_url":"https://matrixflip.com/api","author_username":"wpuser","author_avatar":"https://secure.gravatar.com/avatar/?s=96\u0026d=mm\u0026r=g","categories":[87],"categories_output":[{"ID":87,"slug":"%e5%bc%80%e5%8f%91%e8%b6%a3%e5%91%b3","name":"开发趣味","term_taxonomy_id":87,"term_group":0,"taxonomy":"category","description":"","parent":0,"count":17}],"tags":[88,294,293,90],"tags_output":[{"ID":88,"slug":"centos","name":"CentOS","term_taxonomy_id":88,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":3},{"ID":294,"slug":"%e5%ae%89%e5%85%a8","name":"安全","term_taxonomy_id":294,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":1},{"ID":293,"slug":"%e6%80%a7%e8%83%bd","name":"性能","term_taxonomy_id":293,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":1},{"ID":90,"slug":"%e6%9c%8d%e5%8a%a1%e5%99%a8","name":"服务器","term_taxonomy_id":90,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":3}],"thumbnail":["/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg",770,340,false],"thumbnail_mini":["/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-150x150-matrixflipcomapiwpcontentuploadsccomdddbcddcxxjpg.jpg",150,150,true],"thumbnail_retina":["/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg",770,340,false],"thumbnail_full":["/static-remote/files/c945-com_98d2146dd4b7cd755d21140c-770x340-1-matrixflipcomapiwpcontentuploadsccomdddbcddcxjpg.jpg",770,340,false],"date_day":"21","date_month":"04","date_month_e":"April","date_year":"2022","date_weekday":"Thursday","title":"CentOS 8.0  LEMP环境的性能与安全优化指南2022版","excerpt":"在上一篇文章《从零部署Linux服务器完全指南2022版(CentOS 8+Nginx+PHP)》的基础上，我们完成了LEMP环境的部署，接下去为了提高网站运行的稳定性，我们将对其进行进一步的性能与安全优化。","content":"\u003cp\u003e在上一篇文章\u003ca href=\"https://matrixflip.com/api/the-complete-guide-to-deploying-a-linux-server-from-scratch-version-2022-for-centos8-nginx-php/\" target=\"_blank\" rel=\"noopener\"\u003e《从零部署Linux服务器完全指南2022版(CentOS 8+Nginx+PHP)》\u003c/a\u003e的基础上，我们完成了LEMP环境的部署，接下去为了提高网站运行的稳定性，我们将对其进行进一步的性能与安全优化。\u003c/p\u003e\n\u003cp\u003e整体步骤分为下面的八个：\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003e（一）Mariadb和Nginx服务断开后自动重启\u003cbr /\u003e\n（二）PHP配置修改\u003cbr /\u003e\n（三）启用GZIP压缩\u003cbr /\u003e\n（四）创建交换空间swap space\u003cbr /\u003e\n（五）进一步优化Mariadb\u003cbr /\u003e\n（六）静态文件缓存和PHP缓存\u003cbr /\u003e\n（七）配置Redis缓存mysql数据\u003cbr /\u003e\n（八）学会检查内存占用的程序\u003cbr /\u003e\n（可选）配置DNS到cloudflare提高性能和安全性\u003c/strong\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e这一部分操作顺序不一定要由上至下，但是建议您按照由上至下的顺序循序渐进。\u003c/p\u003e\n\u003ch3\u003e（一）Mariadb和Nginx服务断开后自动重启\u003c/h3\u003e\n\u003cp\u003e\u003cspan style=\"color: #ff0000;\"\u003e推荐使用SH脚本执行\u003c/span\u003e\u003cbr /\u003e\n也可以编辑.sh脚本，并保存，记录.sh文件所在路径【一定确保.sh脚本可用，可以尝试在编辑完成.sh文件后，直接./tomcat.sh 执行脚本文件，查看是否可以正常执行】\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003emkdir /usr/share/nginx/sh\r\nsudo vi /usr/share/nginx/sh/test.sh\u003c/pre\u003e\n\u003cp\u003e测试脚本：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e#!/bin/bash\r\nif [[ \"$(systemctl status nginx.service)\" =~ \"active\" ]]\r\nthen\r\n    echo \"process is running\"\r\nelse\r\n    echo \"process is not running\"\r\nfi\u003c/pre\u003e\n\u003cp\u003e给予权限和执行\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003echmod +x /usr/share/nginx/sh/test.sh\r\n/usr/share/nginx/sh/test.sh\u003c/pre\u003e\n\u003cp\u003e然后删除\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003erm -rf /usr/share/nginx/sh/test.sh\u003c/pre\u003e\n\u003cp\u003e先查看服务器的时间，根据其时间推断中国区域的时间\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003edate\u003c/pre\u003e\n\u003cp\u003e或\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003etimedatectl\u003c/pre\u003e\n\u003cp\u003e始终确保使用 crontab -e 编辑您的 crontab。检测cron定时服务是否自启用\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl is-enabled crond.service\u003c/pre\u003e\n\u003cp\u003e如果未启用，则开启cron自启用\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl enable crond.service\u003c/pre\u003e\n\u003cp\u003e如果已经启用，想要cron关闭自启动\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl disable crond.service\u003c/pre\u003e\n\u003cp\u003e查看cron服务的启动状态[只有cron的状态是active running的，才表示cron服务是启动的]\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl status crond.service\u003c/pre\u003e\n\u003cp\u003e查看增加的定时脚本\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecrontab -l\u003c/pre\u003e\n\u003cp\u003e直接编辑定时脚本\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecrontab -e\u003c/pre\u003e\n\u003ch4\u003e添加自动重启mariadb服务\u003c/h4\u003e\n\u003cblockquote\u003e\u003cp\u003e新增一个sh脚本，当数据库服务出问题时自动启动mariadb服务\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo vi /usr/share/nginx/sh/mysql-check.sh\u003c/pre\u003e\n\u003cp\u003e脚本如下：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e#!/bin/bash\r\nif [[ ! \"$(systemctl is-active mariadb.service )\" =~ \"active\" ]]\r\nthen\r\nsystemctl start mariadb.service\r\nfi\u003c/pre\u003e\n\u003cp\u003e保存文件后，修改其权限\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003echmod u+r+x /usr/share/nginx/sh/mysql-check.sh\u003c/pre\u003e\n\u003cp\u003e直接运行，检测是否能执行（不报Permission denied错即可）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e/usr/share/nginx/sh/mysql-check.sh\u003c/pre\u003e\n\u003cp\u003e添加到自动任务列表,每 15 分钟运行一次命令,\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecrontab -e\u003c/pre\u003e\n\u003cp\u003e脚本如下：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e*/15 * * * * /usr/share/nginx/sh/mysql-check.sh\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003ch4\u003e添加自动重启nginx服务\u003c/h4\u003e\n\u003cblockquote\u003e\u003cp\u003e为了更好地解决信号量过载造成的http连接无法建立，导致服务无法启动这问题，增加一个自动清除信号量的脚本：\u003c/p\u003e\n\u003cp\u003e新增一个sh脚本，当数据库服务出问题时自动启动mariadb服务\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo vi /usr/share/nginx/sh/server-check.sh\u003c/pre\u003e\n\u003cp\u003e脚本如下：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e#!/bin/bash\r\nif [[ ! \"$(systemctl status nginx.service)\" =~ \"active\" ]]\r\nthen\r\nipcrm -a\r\nsystemctl restart nginx.service\r\nfi\u003c/pre\u003e\n\u003cp\u003e保存文件后，修改其权限\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003echmod u+r+x /usr/share/nginx/sh/server-check.sh\u003c/pre\u003e\n\u003cp\u003e直接运行，检测是否能执行（不报Permission denied错即可）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e/usr/share/nginx/sh/server-check.sh\u003c/pre\u003e\n\u003cp\u003e添加到自动任务列表,每 30 分钟运行一次命令,\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecrontab -e\u003c/pre\u003e\n\u003cp\u003e脚本如下：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e*/30 * * * * /usr/share/nginx/sh/server-check.sh\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e查看脚本\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecrontab -l\u003c/pre\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart crond.service\u003c/pre\u003e\n\u003ch3\u003e（二） PHP配置修改\u003c/h3\u003e\n\u003ch4\u003eStep1：配置php.ini\u003c/h4\u003e\n\u003cp\u003e先备份一个原配置：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecp /etc/php.ini /etc/php.ini.bak\u003c/pre\u003e\n\u003cp\u003e修改配置(使用/和n查询字段)\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/php.ini\u003c/pre\u003e\n\u003cp\u003e支持php短标签(如果配置里没有或者被注释了就增加)\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eshort_open_tag = On   #原数值Off\u003c/pre\u003e\n\u003cp\u003e修改上传文件限制为100M(方便上传较大的还原数据)\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eupload_max_filesize = 100M   #原数值2M\u003c/pre\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003cp\u003e下面这两行要修改一下(如果配置里没有或者被注释了就增加)，否则WP一直是8M\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003epost_max_size = 200M   #原数值8M\r\nmax_execution_time = 300   #原数值30\u003c/pre\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart php-fpm nginx\u003c/pre\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e注意：Nginx中设置过server { client_max_body_size 100M; } 属性才能生效\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003ch4\u003eStep2：配置 php-fpm\u003c/h4\u003e\n\u003cp\u003e配置php-fpm的session权限，否则会影响WordPress的功能\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/php-fpm.d/www.conf\u003c/pre\u003e\n\u003cp\u003e查找php_value[session.save_path]字符，找到它储存session的位置为\u003cspan style=\"background-color: #ffff00;\"\u003e /var/lib/php/session\u003c/span\u003e\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003echmod -R 777 /var/lib/php/session\r\nchmod -R 777 /var/lib/php/opcache\r\nchmod -R 777 /var/lib/php/wsdlcache\u003c/pre\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart php-fpm nginx\u003c/pre\u003e\n\u003ch3\u003e（三）启用GZIP压缩\u003c/h3\u003e\n\u003cp\u003e修改Nginx配置，让https支持php等常用配置，代码如下，修改443端口(非www部分)\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/nginx/conf.d/default.conf\u003c/pre\u003e\n\u003cp\u003e加入以下代码：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e     # Gzip Compression\r\n    gzip on;\r\n    gzip_vary on;\r\n    gzip_min_length 1000;\r\n    gzip_proxied expired no-cache no-store private auth;\r\n    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;\u003c/pre\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart nginx\u003c/pre\u003e\n\u003ch3\u003e（四）创建交换空间swap space\u003c/h3\u003e\n\u003cp\u003e首先使用\u003cspan style=\"background-color: #ffff00;\"\u003edf -h\u003c/span\u003e和\u003cspan style=\"background-color: #ffff00;\"\u003efree -m\u003c/span\u003e命令查看内存使用情况和swap的大小\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/902a9270fb2a13e3a1ec264a-matrixflipcomapiwpcontentuploadsafbaeaecajpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e创建Swap文件（这里创建了4G的交换空间）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo fallocate -l 4G /swapfile\u003c/pre\u003e\n\u003cp\u003e检查是否创建OK\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003els -lh /swapfile\u003c/pre\u003e\n\u003cp\u003e启用Swap文件\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo chmod 600 /swapfile\r\nls -lh /swapfile\u003c/pre\u003e\n\u003cp\u003e既然我们的交换文件更安全，我们可以通过输入以下内容告诉我们的系统设置交换空间以供使用：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo mkswap /swapfile\r\nsudo swapon /swapfile\u003c/pre\u003e\n\u003cp\u003e为了验证程序是否成功，我们可以检查我们的系统现在是否报告交换空间：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eswapon -s\r\nfree -m\u003c/pre\u003e\n\u003cp\u003e使交换文件永久化\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo vi /etc/fstab\u003c/pre\u003e\n\u003cp\u003e最底部添加下面代码让系统使用并自动挂载\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e/swapfile swap swap defaults 0 0\u003c/pre\u003e\n\u003cp\u003e重新查看\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003efree -m\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/6bb42232e3c3509309361997-matrixflipcomapiwpcontentuploadsbbecjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003e(可选，目前未设置）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e调整 Swappiness 值。Swappiness 是一个 Linux 内核属性，它定义了系统使用交换的频率空间。 Swappiness 可以有一个介于 0 和 100 之间的值。低值将使内核尽量避免交换，而较高的值将使内核更积极地使用交换空间。CentOS 8 上的默认 swappiness 值为 30。您可以查看当前的 swappiness\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecat /proc/sys/vm/swappiness\u003c/pre\u003e\n\u003cp\u003e虽然 30 的 swappiness 值对于桌面和开发机器是可以的，但对于生产服务器，您可能需要设置一个较低的值。更改参数，要使此参数在重新启动后保持不变：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/sysctl.conf\r\nvm.swappiness=10\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003chr /\u003e\n\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003e(可选，目前未设置）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e要停用和删除交换文件，请按照下列步骤操作：\u003c/p\u003e\n\u003cp\u003e通过键入以下内容停用交换空间：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo swapoff -v /swapfile\u003c/pre\u003e\n\u003cp\u003e从 /etc/fstab 中删除交换条目 /swapfile swap swap defaults 0 0\u003c/p\u003e\n\u003cp\u003e删除文件\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo rm /swapfile\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003ch3\u003e\u003c/h3\u003e\n\u003ch3\u003e（五）进一步优化Mariadb\u003c/h3\u003e\n\u003cp\u003e模拟和解决可能遇见的问题如下：\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e(1) Error establishing a database connection\u003cbr /\u003e\n(2) Warning: mysqli_real_connect(): (HY000/2002): Connection refused in\u003cbr /\u003e\n(3) Deprecated: mysql_connect(): The mysql extension is deprecated and will be removed in the future: use mysqli or PDO instead in …\u003cbr /\u003e\n(4) Warning: mysql_connect(): Connection refused…\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch4\u003eStep1: 修改最大连接数\u003c/h4\u003e\n\u003cp\u003e避免mysqli_real_connect():Connection refused in类似错误，可能是由于连接数超过了被拒绝\u003c/p\u003e\n\u003cp\u003e检查mariadb的版本信息\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003erpm -qa | grep mariadb\u003c/pre\u003e\n\u003cp\u003e查看mariadb的最大连接数为默认151(输入密码)\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003erpm -qa | grep mariadb\u003c/pre\u003e\n\u003cp\u003e检查mysql版本\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003erpm -qa |grep mysql\u003c/pre\u003e\n\u003cp\u003e先备份一个配置文件，修改配置文件，增加最大连接数\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo cp /etc/my.cnf /etc/my.cnf.bak\r\nvi /etc/my.cnf\u003c/pre\u003e\n\u003cp\u003e在调整为 MySQL 分配多少内存时，只需要更新分配给innodb_buffer_pool_size的值。 不要更新其他参数，添加3行代码：\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e①对于具有小型 RAM (\u0026lt;= 1GB) 的系统,最好使用 MySQL 默认配置值 128MB 作为 InnoDB 缓冲池大小。\u003cbr /\u003e\n②适用于具有中型 RAM (1GB – 32GB) 的系统,我们可以使用以下粗略的启发式方法计算操作系统需求：256MB + 256 * log2（以 GB 为单位的 RAM 大小）\u003c/p\u003e\u003c/blockquote\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e[mysqld]\r\nmax_connections=1000\r\ninnodb_buffer_pool_size = 128M\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/efb4376be12632d62452950e-matrixflipcomapiwpcontentuploadsefbbedejpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e重启mariadb服务，再次查看mariadb数据库最大连接数，可以看到最大连接数是214，并非我们设置的1000。这是由于mariadb有默认打开文件数限制。可以通过配置/usr/lib/systemd/system/mariadb.service来调大打开文件数目。\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart mariadb.service\u003c/pre\u003e\n\u003cp\u003e先备份一个原配置：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecp /usr/lib/systemd/system/mariadb.service /usr/lib/systemd/system/mariadb.service.bak\u003c/pre\u003e\n\u003cp\u003e配置文件\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /usr/lib/systemd/system/mariadb.service\u003c/pre\u003e\n\u003cp\u003e[Service]新添加两行如下参数：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eLimitNOFILE=10000\r\nLimitNPROC=10000\u003c/pre\u003e\n\u003cp\u003e重新加载系统服务，并重启mariadb服务, 再次查看mariadb数据库最大连接数，可以看到最大连接数已经是1000\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl --system daemon-reload  \r\nsystemctl restart mariadb.service\u003c/pre\u003e\n\u003cp\u003e再次查看mariadb的最大连接数\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003emysqladmin -uroot -p variables |grep max_connections\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/0718ff54cde627b357608df7-matrixflipcomapiwpcontentuploadsffcdebdfjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e查看mysql的建立的连接数\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003enetstat -n | awk '/^tcp/ {++state[$NF]} END {for(key in state) print key,\"\\t\",state[key]}'\u003c/pre\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e进入mysql终端，此时输入密码\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\" style=\"line-height: 1.42857;\"\u003emysql -u root -p\u003c/pre\u003e\n\u003cp\u003e进入mysql终端后的命令\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\" style=\"line-height: 1.42857;\"\u003eselect version();   #查看当前mysql版本\r\nshow status like 'Threads%';    #查看当前mysql连接数\r\nshow variables like '%max_connections%';   #查看当前mysql最大连接数\r\nshow variables like 'log_%';  #是否启用错误日志\r\nshow master status; #当前日志是否存在\r\nQUIT; #退出\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003ch4\u003eStep2: Mariadb关闭后自动重连接\u003c/h4\u003e\n\u003cp\u003e查看mariadb的日志\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003etail /var/log/mariadb/mariadb.log\u003c/pre\u003e\n\u003cp\u003e崩溃后自动重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/systemd/system/multi-user.target.wants/mariadb.service\u003c/pre\u003e\n\u003cp\u003e在[Service]下面加入以下行（如果已经存在则修改值，默认值为\u003cspan style=\"color: #ff0000;\"\u003eon-abort\u003c/span\u003e中止）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eRestart=always\u003c/pre\u003e\n\u003cp\u003e重新加载系统守护程序\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo systemctl daemon-reload\r\nsudo systemctl restart mariadb.service\u003c/pre\u003e\n\u003cp\u003e重启服务器,稍等十几秒后恢复\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo reboot\u003c/pre\u003e\n\u003cp\u003e模拟数据库崩溃的效果，查找进程看到类似ID后可以kill掉\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eps -ef | grep mysql\u003c/pre\u003e\n\u003cp\u003e强制终止进程（如果/etc/systemd/system/multi-user.target.wants/mariadb.service文件修改成功，择数据库被kill后，会立刻重启恢复）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo kill -9 1179\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/5ad1f21e3652b91cd741ab73-matrixflipcomapiwpcontentuploadsadfebcdabjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003ch4\u003eStep3: Mysql进程崩溃后自动重启\u003c/h4\u003e\n\u003cp\u003e需要配置/etc/inittab文件，首先备份一个，编辑此文件一定要非常小心\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo cp /etc/inittab /etc/inittab.bak\r\nvi /etc/inittab\u003c/pre\u003e\n\u003cp\u003e结尾处增加一行，在/ etc / inittab文件中放置一个命令，以在mysqld_safe进程崩溃时重新生成mysqld_safe进程。 它有四个字段，每个字段与冒号\u003cspan style=\"background-color: #ffff00;\"\u003e（:)\u003c/span\u003e分隔开\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ems:2345:respawn:/bin/sh /usr/bin/mysqld_safe\u003c/pre\u003e\n\u003cp\u003e保存后重启服务\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart mariadb.service\u003c/pre\u003e\n\u003cp\u003e重启服务器,稍等十几秒后恢复\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo reboot\u003c/pre\u003e\n\u003cp\u003e查看服务状态\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo service mariadb status\u003c/pre\u003e\n\u003ch3\u003e（六）静态文件缓存和PHP缓存\u003c/h3\u003e\n\u003cp\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e特别注意：\u003c/strong\u003e不要使用 /usr/share/nginx/目录作为缓存文件夹，因为如果不执行sudo setenforce 0，系统将无法自己创建缓存文件，绕过SELinux是很危险的，使用/var/lib/nginx/文件夹，默认被SELinux允许\u003c/span\u003e\u003c/p\u003e\n\u003ch4\u003eStep1: PHP缓存设置\u003c/h4\u003e\n\u003cp\u003e先配置nginx的根文件，配置PHP的缓存\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/nginx/nginx.conf\u003c/pre\u003e\n\u003cp\u003e在\u003cspan style=\"background-color: #ffff00;\"\u003ehttp { ... }\u003c/span\u003e 中加入代码，使用/var/lib/nginx/cache作为php的缓存文件夹\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e    # Enable PHP cache\r\n    fastcgi_cache_path /var/lib/nginx/cache levels=1:2 keys_zone=MYAPP:100m inactive=60m max_size=40m;\r\n    fastcgi_cache_key \"$scheme$request_method$host$request_uri\";\u003c/pre\u003e\n\u003cp\u003e接着修改server配置文件\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/nginx/conf.d/default.conf\u003c/pre\u003e\n\u003cp\u003e\u003cspan style=\"background-color: #ffff00;\"\u003eserver { location ~ \\.php$ { ... } }\u003c/span\u003e中加入代码配置PHP缓存，60m是60分钟：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e        # Enable PHP cache\r\n        fastcgi_cache MYAPP;\r\n        fastcgi_cache_valid 200 301 302 60m;\r\n        fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;\r\n        fastcgi_cache_min_uses 1;\r\n        fastcgi_cache_lock on;\r\n        add_header X-FastCGI-Cache $upstream_cache_status;\u003c/pre\u003e\n\u003cp\u003e生成缓存文件夹，给权限\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003emkdir /var/lib/nginx/cache\u003c/pre\u003e\n\u003cp\u003e\u003cspan style=\"color: #ff0000;\"\u003e必须给予权限才能从客户端访问缓存:\u003c/span\u003e\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esudo chown -R myftp1:www-data /var/lib/nginx/cache\u003c/pre\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart nginx php-fpm\u003c/pre\u003e\n\u003cp\u003e新建一个PHP缓存测试文件\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /usr/share/nginx/html/wordpress/time.php\u003c/pre\u003e\n\u003cp\u003e脚本如下：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e\u0026lt;?php\r\necho time();\r\n?\u0026gt;\u003c/pre\u003e\n\u003cp\u003e测试缓存效果：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecurl -I https://yoursite.com/time.php\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003ex-fastcgi-cache\u003c/strong\u003e 的值出现\u003cspan style=\"background-color: #ffff00;\"\u003eHIT\u003c/span\u003e表示生效，而且time.php的时间数值不会变动\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/108f763c025f5b53287fe939-matrixflipcomapiwpcontentuploadsfcfbfejpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e清除缓存：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003erm -rf /var/lib/nginx/cache/*\u003c/pre\u003e\n\u003ch4\u003eStep2: Nginx静态文件缓存设置\u003c/h4\u003e\n\u003cp\u003e先配置nginx的根文件，配置静态文件缓存的Expires map\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/nginx/nginx.conf\u003c/pre\u003e\n\u003cp\u003e在\u003cspan style=\"background-color: #ffff00;\"\u003ehttp { ... }\u003c/span\u003e 中加入代码（缓存某些目录下的文件30天，HTML文件不会被缓存）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e    # Expires map\r\n    map $sent_http_content_type $expires {\r\n        default                    off;\r\n        text/html                  epoch;\r\n        text/css                   30d;\r\n        application/javascript     30d;\r\n        ~image/                    30d;\r\n        ~images/                   30d;\r\n        ~videos/                   30d;\r\n        ~models/                   30d;\r\n        ~fonts/                    30d;\r\n        ~font/                     30d;\r\n        ~wp-content/uploads/       30d; \r\n    }\u003c/pre\u003e\n\u003cp\u003e接着修改server配置文件\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/nginx/conf.d/default.conf\u003c/pre\u003e\n\u003cp\u003e\u003cspan style=\"background-color: #ffff00;\"\u003eserver { ... }\u003c/span\u003e中加入代码配置静态文件缓存：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003e    # Expires static files\r\n    expires $expires;\u003c/pre\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart nginx\u003c/pre\u003e\n\u003cp\u003e测试缓存效果【注意：此缓存是储存在客户端(浏览器)上的配置，不是直接从服务端读取】：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecurl -I /static-remote/files/xxxxxxxxx-yoursitecomxxxxxxxxxjpg.jpg\r\n\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/98786e1222cbd526f68bdbf1-matrixflipcomapiwpcontentuploadsecbdfbdbfjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/df7a94714ae20101dfccb7ea-matrixflipcomapiwpcontentuploadsdfaaedfccbeajpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003ch3\u003e（七）配置Redis缓存mysql数据\u003c/h3\u003e\n\u003cp\u003e安装redis（目前版本5.0.3）\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ednf install redis -y\u003c/pre\u003e\n\u003cp\u003e启动\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl start redis\r\nsystemctl enable redis\u003c/pre\u003e\n\u003cp\u003e查看状态\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl status redis\u003c/pre\u003e\n\u003cp\u003e检查端口\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ess -ant | grep 6379  或者  semanage port -l | grep \"redis\"\u003c/pre\u003e\n\u003cp\u003e测试redis连接\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eredis-cli\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003e输入：\u003cspan style=\"background-color: #ffff00;\"\u003eping\u003cbr /\u003e\n\u003c/span\u003e输入：\u003cspan style=\"background-color: #ffff00;\"\u003eINFO server\u003c/span\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/77c66b8fda72b84189cede2c-matrixflipcomapiwpcontentuploadscbfdabcedecjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e配置redis,先备份一个\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003ecp /etc/redis.conf /etc/redis.conf.bak\u003c/pre\u003e\n\u003cp\u003e配置\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003evi /etc/redis.conf\u003c/pre\u003e\n\u003cp\u003e结尾处添加：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003emaxmemory 128mb\r\nmaxmemory-policy allkeys-lru\u003c/pre\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003e（可选）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e默认情况下，redis-cli 允许您在 Raedis shell 中运行任何命令。 因此，使用密码保护 Redis shell 是一个好主意。 您可以启用密码验证：\u003c/p\u003e\n\u003cp\u003e找到下面这行：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\" style=\"line-height: 1.42857;\"\u003e# requirepass foobared\u003c/pre\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003cp\u003e改成密码即可：\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\" style=\"line-height: 1.42857;\"\u003erequirepass yourpassword\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e重启\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003esystemctl restart redis\u003c/pre\u003e\n\u003cp\u003eWordPress安装插件来启用和检查redis使用情况\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRedis Object Cache\u003c/strong\u003e用来启用redis\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/6f92ed6bb2e8d8bd2ee362c8-matrixflipcomapiwpcontentuploadsfedbbedbdeecjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eQuery Monitor\u003c/strong\u003e用来检测mysql链接情况，出现下图表示存在缓存（OK后卸载即可，使用一个插件就行）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/dbb5907316dd4ccdaf6cfc0d-matrixflipcomapiwpcontentuploadsdbbddccdafcfcdjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e可以使用终端检查\u003c/p\u003e\n\u003cpre class=\"codePre brush: js;\"\u003eredis-cli monitor\u003c/pre\u003e\n\u003cp\u003e刷新网站出现\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/6a7f44ef1037dab0b3dfc41e-matrixflipcomapiwpcontentuploadsafefdabbdfcejpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003cp\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e注意：\u003c/strong\u003eSELinux安全策略 （sudo setenforce 1）启动后redis连接将会失效，未来保障安全，我们不能关闭安全策略，所以暂时禁用redis。\u003c/span\u003e\u003c/p\u003e\n\u003ch3\u003e（八）学会检查内存占用的程序\u003c/h3\u003e\n\u003cp\u003e可以简单实用top命令，然后访问网站，就会动态出现内存占用的程序，学会分析他们\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static-remote/files/d084ae19524ed0b082f53106-matrixflipcomapiwpcontentuploadsdaeedbfjpg.jpg\" alt=\"\" /\u003e\u003c/p\u003e\n\u003ch3\u003e（可选） 配置DNS到cloudflare提高性能和安全性\u003c/h3\u003e\n\u003cp\u003e首先注册Cloudflare账号，然后添加一个域名，登录你的域名注册商的后台，把DNS修改为\u003cspan style=\"background-color: #ffff00;\"\u003edax.ns.cloudflare.com\u003c/span\u003e 和\u003cspan style=\"background-color: #ffff00;\"\u003esue.ns.cloudflare.com\u003c/span\u003e即可，具体的设置可以参看Cloudflare官网\u003c/p\u003e\n\u003cp\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e注意：\u003c/strong\u003eCloudflare不支持特殊端口号，如果网站使用了其它端口号挂载资源，需要使用Cloudflare Spectrum来支持其它端口号（付费服务）\u003c/span\u003e\u003c/p\u003e\n\u003ch3\u003e结语\u003c/h3\u003e\n\u003cp\u003e看到这了，差不多完整的一整套部署已经可以正常稳定（相对稳定，并不代表不会被攻击，或者使用的后台有漏洞，这些需要自己去注意）使用了。目前CentOS 8的生命周期已经结束，我们也可以在此基础上，继续升级到CentOS Stream 9，整体的搭建思路其实差不多，主要注意一些命令、安全机制的差异，之后如果我自己的某些站点启用了CentOS Stream 9的话，也会实战一下从零部署并发布相关文章，希望本文对你有帮助，感兴趣可以继续关注我，会不定期分享一些东西。：）\u003c/p\u003e\n","slug":"performance-and-security-optimization-guide-for-centos8-lemp-environment-2022","prev":[{"ID":893333,"title":"从零部署Linux服务器完全指南2022版(CentOS 8+Nginx+PHP)","excerpt":"之前我的一个CentOS 7 Apache的站点被攻击，导致流量过载损失了一笔钱，由于也是边学习边部署的，有不少安全隐患，为了避免常见安全隐患再次发生，后来找出大概的原因后决定重新部署一个基于CentOS 8 Nginx的服务器。这也是充分利用Google和自己探索的一些从零部署的技巧和方法。","slug":"the-complete-guide-to-deploying-a-linux-server-from-scratch-version-2022-for-centos8-nginx-php","post_date":"2022-04-06 17:28:22","post_date_gmt":"2022-04-06 17:28:22","thumbnail":["/static-remote/files/c945-com_916eabee741055d527937c48-770x340-4-matrixflipcomapiwpcontentuploadsccomeabeedcxjpg.jpg",770,340,false],"thumbnail_mini":["/static-remote/files/c945-com_916eabee741055d527937c48-770x340-4-150x150-matrixflipcomapiwpcontentuploadsccomeabeedcxxjpg.jpg",150,150,true],"thumbnail_retina":["/static-remote/files/c945-com_916eabee741055d527937c48-770x340-4-matrixflipcomapiwpcontentuploadsccomeabeedcxjpg.jpg",770,340,false]}],"next":[{"ID":24272280,"title":"理解微前端 - 从部署一套自己的前端开发环境(脚手架)开始","excerpt":"很久以前的前端，没有太多工具化工程化思想，一堆代码塞进去完事儿。如今前端已经很卷，卷到了一个开发环境都够你折腾一宿。那么我们抛开类似nextjs、create-react-app这类的工具或框架，我们该如何从零部署一个属于自己的开发环境呢？这篇文章将讲述如何配置一个基础的脚手架，支持React、TypeScrit和单元测试等必要的功能。在这个基础上，大家能够很方便去个性化脚手架。","slug":"b214e53f0c655e422783718d","post_date":"2022-05-13 08:15:01","post_date_gmt":"2022-05-13 08:15:01","thumbnail":["/static-remote/files/c945-com_74f6c1c0c632283a68276851-770x340-1-matrixflipcomapiwpcontentuploadsccomfcccaxjpg.jpg",770,340,false],"thumbnail_mini":["/static-remote/files/c945-com_74f6c1c0c632283a68276851-770x340-1-150x150-matrixflipcomapiwpcontentuploadsccomfcccaxxjpg.jpg",150,150,true],"thumbnail_retina":["/static-remote/files/c945-com_74f6c1c0c632283a68276851-770x340-1-matrixflipcomapiwpcontentuploadsccomfcccaxjpg.jpg",770,340,false]}],"post_date":"2022-04-21 16:35:43","post_date_gmt":"2022-04-21 16:35:43","post_status":"publish","comment_status":"open","ping_status":"open","post_password":"","to_ping":"","pinged":"","post_modified":"2022-04-22 08:49:10","post_modified_gmt":"2022-04-22 08:49:10","post_content_filtered":"","post_parent":0,"guid":"https://matrixflip.com/api/?post_type=post\u0026#038;p=903333","menu_order":0,"post_type":"post","post_mime_type":"","comment_count":"0","filter":"raw"},"postID":"performance-and-security-optimization-guide-for-centos8-lemp-environment-2022"},"__N_SSG":true},"page":"/article/[id]","query":{"id":"performance-and-security-optimization-guide-for-centos8-lemp-environment-2022.html"},"buildId":"or2KW4Yk6XXL-Cofu9R5v","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>