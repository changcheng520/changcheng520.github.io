<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>gRPC与前端应用的完整实现过程 - 没位道</title><meta name="description" content="最近我在参与设计一个软件的架构，期间也遇到不少困难，但是只要用心去思考还是可以解决的。前端和隔离层（包括 UI层，文件管理系统，插件系统，数据处理等）的微服务基于 React + Nextjs + Nodejs + Lerna + gRPC，后端协议遵循HTTP/2的长连接及其双向通信。那么不得不说一说 gRPC。也许很多中小型项目都并未采用，它相对于REST是有一些麻烦的地方。但是鉴于大型项目的数据交互，请求与相应，也许它是一个非常好的选择。关于 gRPC 请自行去搜索相关资料了解，这篇文章主要是完整实现一个从零到一的演示。"/><meta property="og:title" content="gRPC与前端应用的完整实现过程 - 没位道"/><meta property="og:description" content="最近我在参与设计一个软件的架构，期间也遇到不少困难，但是只要用心去思考还是可以解决的。前端和隔离层（包括 UI层，文件管理系统，插件系统，数据处理等）的微服务基于 React + Nextjs + Nodejs + Lerna + gRPC，后端协议遵循HTTP/2的长连接及其双向通信。那么不得不说一说 gRPC。也许很多中小型项目都并未采用，它相对于REST是有一些麻烦的地方。但是鉴于大型项目的数据交互，请求与相应，也许它是一个非常好的选择。关于 gRPC 请自行去搜索相关资料了解，这篇文章主要是完整实现一个从零到一的演示。"/><meta property="og:url" content="https://www.c945.com/article/implementation-process-of-grpc-and-front-end-applications-completely.html"/><meta property="og:image" content="https://www.c945.com/static-remote/files/medium-blog-cover-1200x771-grpc-770x340-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg"/><meta name="next-head-count" content="6"/><link rel="icon" href="/assets/images/favicon/favicon-32x32.png" type="image/x-icon"/><link rel="shortcut icon" href="/assets/images/favicon/favicon-32x32.png" sizes="32x32"/><link rel="apple-touch-icon" href="/assets/images/favicon/apple-touch-icon-57x57.png"/><link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicon/apple-touch-icon-72x72.png"/><link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicon/apple-touch-icon-114x114.png"/><link rel="preload" href="/_next/static/css/ab4d44a60d7a5fe0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ab4d44a60d7a5fe0.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a80a7b96b8396f08.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a80a7b96b8396f08.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-803820e42116e4e4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5816f20eb504df5c.js" defer=""></script><script src="/_next/static/chunks/424-328589773c4cbd07.js" defer=""></script><script src="/_next/static/chunks/669-26e51e3e61a246e5.js" defer=""></script><script src="/_next/static/chunks/355-8e546d82173371b2.js" defer=""></script><script src="/_next/static/chunks/782-9ef19db02a591dc2.js" defer=""></script><script src="/_next/static/chunks/pages/article/%5Bid%5D-eb52e5d17e91782f.js" defer=""></script><script src="/_next/static/USGe3Qzz7MTVE_wvPjEkq/_buildManifest.js" defer=""></script><script src="/_next/static/USGe3Qzz7MTVE_wvPjEkq/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="main-wrapper"><div class="loading-spirit loaded"><i class="fa fa-spinner fa-spin fa-3x fa-fw margin-bottom"></i></div><div class="styles_back-to-top__xN2cj"><button type="button" class=""><svg width="40" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300.222 300.221"><g><path d="M299.201,93.188c-14.688-25.704-29.988-50.184-43.452-76.5c-3.06-6.12-12.852-4.284-14.688,1.836 c-7.345,26.316-16.524,58.14-15.301,85.068c0,6.12,6.732,7.344,10.404,4.284c0.612,0.612,1.836,0.612,3.061,0.612 c6.731-0.612,13.464-1.836,19.584-2.448c22.031,55.692,39.779,152.388-44.677,158.508c-8.567,0.612-15.3-1.224-20.195-4.896 c11.628-9.792,21.42-22.031,26.315-36.107c6.732-18.36-6.731-57.528-31.824-46.512c-20.195,9.18-24.479,45.899-20.808,64.26 c1.224,5.508,3.06,10.403,4.896,14.688c-1.837,1.225-3.061,1.836-4.896,3.061c-15.912,9.18-34.883,13.464-53.244,12.852 c-13.464-0.612-21.42-7.956-26.316-17.748c16.524-8.567,29.988-22.032,33.66-36.107c7.344-29.988-31.212-49.572-47.124-20.196 c-7.344,13.464-8.568,32.436-4.284,48.96c-0.612,0.612-1.836,0.612-2.448,1.224c-52.632,21.42-68.544-45.288-38.556-78.336 c2.448-3.06-0.612-7.956-4.284-5.508c-36.108,25.704-33.048,80.784,8.568,98.532c11.016,4.896,26.928,3.06,41.616-1.836 c6.732,13.464,17.748,23.868,33.66,25.704c23.868,3.06,51.408-3.673,73.44-17.137c12.852,10.404,31.212,12.853,50.184,8.568 c80.172-15.912,65.484-113.832,42.228-171.972c6.12-0.612,11.629-0.612,17.748-0.612 C297.978,105.427,302.261,98.083,299.201,93.188z M83.166,240.067c-0.612-4.283-1.224-8.567-1.224-12.852 c0-6.732,1.224-13.464,3.06-19.584c4.284-14.688,29.988-9.792,22.032,9.792C102.138,226.603,92.958,234.559,83.166,240.067z M180.473,229.664c0-8.568,3.673-39.168,16.524-39.78c9.792-0.612,9.792,26.316,9.18,30.6c-2.447,11.629-11.016,21.42-21.42,28.765 C181.697,243.127,180.473,236.395,180.473,229.664z M252.077,43.615c8.568,15.912,17.748,31.212,26.928,46.512 c-12.852,1.836-25.704,4.284-37.943,7.344C246.569,80.947,249.018,61.975,252.077,43.615z"></path></g></svg></button></div><header class="header axil-header axil-header--page header-style-1 splash-header-style "><div class="axil-mainmenu "><div class="container"><div class="header-navbar"><div class="header-logo"><a href="/default.html"><img src="/assets/images/logo-light.png" alt="logo" width="150"/><img class="sticky-logo" src="/assets/images/logo-dark.png" alt="logo" width="100"/></a></div><div class="header-main-nav"><nav class="mainmenu-nav"><ul class="mainmenu"><li class="nav-item"><a class="nav-link active" href="/articles/page/1.html"><i class="fa fa-solid fa-quote-left"></i>文章</a></li><li class="nav-item"><a class="nav-link" href="/works.html"><i class="fa fa-solid fa-briefcase"></i>作品</a></li><li class="nav-item"><a class="nav-link" href="/products.html"><i class="fa fa-solid fa-code"></i>产品</a></li><li class="nav-item"><a class="nav-link" href="/about.html"><i class="fa fa-duotone fa-user"></i>关于</a></li><li class="nav-item"><a class="nav-link" href="/links.html"><i class="fa fa-solid fa-link"></i>友情链接</a></li></ul></nav></div><div class="header-action"><ul class="list-unstyled"><li class="mobile-menu-btn sidemenu-btn d-lg-none d-block"><button class="btn-wrap"><span></span><span></span><span></span></button></li></ul></div></div></div></div><div class="mobilemenu-popup"><div class="mobilemenu-inner"><div class="mobilemenu-header"><div class="mobile-nav-logo"><a href="/"><img src="/assets/images/logo-dark.png" alt="logo" width="100"/></a></div><button class="mobile-menu-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="10"><path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"></path></svg></button></div><div class="mobilemenu-body"><nav class="mainmenu-nav"><ul class="mainmenu"><li class="nav-item"><a class="nav-link active" href="/articles/page/1.html"><i class="fa fa-solid fa-quote-left"></i>文章</a></li><li class="nav-item"><a class="nav-link" href="/works.html"><i class="fa fa-solid fa-briefcase"></i>作品</a></li><li class="nav-item"><a class="nav-link" href="/products.html"><i class="fa fa-solid fa-code"></i>产品</a></li><li class="nav-item"><a class="nav-link" href="/about.html"><i class="fa fa-duotone fa-user"></i>关于</a></li><li class="nav-item"><a class="nav-link" href="/links.html"><i class="fa fa-solid fa-link"></i>友情链接</a></li></ul></nav></div></div></div></header><div class="section call-to-action-area splash-call-to-action call-to-action-area--page"><ul class="list-unstyled shape-group-9"><li class="shape shape-1"><img src="/assets/images/others/bubble-12.png" alt="Comments"/></li><li class="shape shape-2"><img src="/assets/images/others/bubble-16.png" alt="Comments"/></li><li class="shape shape-3"><img src="/assets/images/others/bubble-13.png" alt="Comments"/></li><li class="shape shape-4"><img src="/assets/images/others/bubble-14.png" alt="Comments"/></li><li class="shape shape-5"><img src="/assets/images/others/bubble-16.png" alt="Comments"/></li><li class="shape shape-6"><img src="/assets/images/others/bubble-15.png" alt="Comments"/></li><li class="shape shape-7"><img src="/assets/images/others/bubble-16.png" alt="Comments"/></li></ul></div><nav id="onepagenav" class="service-scroll-nav navbar app-primary-nav app-primary-nav--page"><div class="container"><ul class="nav nav-pills"><li class="nav-item"><a class="nav-link current" href="/articles/page/1.html"><i class="fa fa-solid fa-quote-left"></i>文章</a></li><li class="nav-item"><a class="nav-link" href="/works.html"><i class="fa fa-solid fa-briefcase"></i>作品</a></li><li class="nav-item"><a class="nav-link" href="/products.html"><i class="fa fa-solid fa-code"></i>产品</a></li><li class="nav-item"><a class="nav-link" href="/about.html"><i class="fa fa-duotone fa-user"></i>关于</a></li><li class="nav-item"><a class="nav-link" href="/links.html"><i class="fa fa-solid fa-link"></i>友情链接</a></li></ul></div></nav><section class="section section-padding blog-post-content-show"><div class="container"><div class="row"><div class="blog-post__title"><div class="container"><div class="row"><div class="col-md-8 offset-md-2 col-sm-10 offset-sm-1 text-center"><h1 class="h2">gRPC与前端应用的完整实现过程</h1><div class="blog-post__author">March<!-- --> <!-- -->16<!-- -->, <!-- -->2023<span><em>  by   </em></span><span class="h6">Chuckie Chang<!-- --> | 分类至:  <a title="开发趣味" href="/articles/sort/%e5%bc%80%e5%8f%91%e8%b6%a3%e5%91%b3/page/1.html"><span>开发趣味</span></a></span></div></div></div></div><div class="elementor-image-holder text-center"><img src="/static-remote/files/medium-blog-cover-1200x771-grpc-770x340-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg" alt="gRPC与前端应用的完整实现过程"/></div></div></div></div><div class="container type-blog-output"><div class="row"><div class="col-md-8 offset-md-2"><div><p>最近我在参与设计一个软件的架构，期间也遇到不少困难，但是只要用心去思考还是可以解决的。前端和隔离层（包括 UI层，文件管理系统，插件系统，数据处理等）的微服务基于 React + Nextjs + Nodejs + Lerna + gRPC，后端协议遵循HTTP/2的长连接及其双向通信。那么不得不说一说 gRPC。也许很多中小型项目都并未采用，它相对于REST是有一些麻烦的地方。但是鉴于大型项目的数据交互，请求与相应，也许它是一个非常好的选择。关于 gRPC 请自行去搜索相关资料了解，这篇文章主要是完整实现一个从零到一的演示。</p>
<p>这个过程中，编译 proto 文件会用到 grpc, grpc-web 和相关的一些插件, 服务测试将使用 envoy 代理和 webpack。好了废话不多说，我们开始吧：</p>
<p>&nbsp;</p>
<h4><img class="alignnone size-full wp-image-24272798" src="/static-remote/files/grpc-preview-matrixflipcomapiwpcontentuploadsgrpcpreviewgif.gif" alt="" width="1280" height="720" /></h4>
<h4 id="-">目录结构</h4>
<pre>grpc-getting-started/
├── README<span class="hljs-selector-class">.md</span>
├── LICENSE 
├── package<span class="hljs-selector-class">.json</span>
├── package-lock<span class="hljs-selector-class">.json</span>
├── envoy<span class="hljs-selector-class">.yaml</span>
├── server<span class="hljs-selector-class">.js</span>
├── build/          
├── scripts/  
├── dist/
│   ├── client-main<span class="hljs-selector-class">.js</span>
│   └── index<span class="hljs-selector-class">.html</span>
├── proto/                
│   ├── example<span class="hljs-selector-class">.proto</span>
│   └── other<span class="hljs-selector-class">.proto</span>
├── src/
│   ├── proto/
│   ├── client/
│   └── server/
└──
</pre>
<h3 id="-1-">(1) 定义服务</h3>
<p>我们首先定义一个服务，指定可以远程调用的方法及其参数和返回类型。</p>
<p>这是使用在 .proto 文件中使用协议缓冲完成的，它们还用于描述有效负载消息的结构。</p>
<p>创建一个 proto 文件 <code>proto/example.proto</code>：</p>
<pre><span class="hljs-comment">// 步骤 1. 基本配置</span>
<span class="hljs-comment">// ================================================ ====</span>
<span class="hljs-comment">// 第一行告诉编译器这个文件中使用了什么语法。</span>
<span class="hljs-comment">// 第二行属于命名空间，用来防止不同的消息类型有命名冲突</span>

syntax = <span class="hljs-string">"proto3"</span>;
<span class="hljs-keyword">package</span> hello;


<span class="hljs-comment">// 步骤 2. 定义消息结构</span>
<span class="hljs-comment">// ================================================ ====</span>
<span class="hljs-comment">// 这定义了请求负载。 此处进入消息的每个属性都与其类型一起定义。</span>
<span class="hljs-comment">// 需要为每个属性分配一个唯一的编号，称为标签。 协议缓冲区使用此标记来表示属性，而不是使用属性名称。</span>
<span class="hljs-comment">// 所以，不像 JSON 我们每次都会传递属性名称 firstName，protocol buffer 会使用数字 1 来表示 firstName。 响应负载定义类似于请求。</span>


<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">HelloRequest</span> </span>{
    <span class="hljs-built_in">string</span> firstName = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">string</span> lastName = <span class="hljs-number">2</span>;
}

<span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">HelloResponse</span> </span>{
    <span class="hljs-built_in">string</span> greeting = <span class="hljs-number">1</span>;
}


<span class="hljs-comment">// 步骤 3. 定义服务契约</span>
<span class="hljs-comment">// ================================================ ====</span>
<span class="hljs-comment">// 最后，让我们定义服务契约。 对于我们的 HelloService，我们定义了一个 GetHelloReq() 操作：</span>

<span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">HelloService</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">rpc</span> GetHelloReq(HelloRequest) <span class="hljs-keyword">returns</span> (HelloResponse)</span>;
}
</pre>
<h3 id="-2-proto-js-">(2) 生成代码 —— 将 <code>.proto</code> 文件编译为 <code>.js</code></h3>
<h4 id="-2-1-grpc-web-https-github-com-grpc-grpc-web-">步骤 2.1。 安装 <a href="https://github.com/grpc/grpc-web">grpc-web</a> 运行时库</h4>
<pre><span class="hljs-variable">$ </span>cd /{your_directory}/grpc-getting-started
<span class="hljs-variable">$ </span>npm i --save-dev grpc-web
</pre>
<h4 id="-2-2-typescript-ts-protoc-gen-https-github-com-improbable-eng-ts-protoc-gen-">步骤 2.2。 安装生成 TypeScript 的插件 <a href="https://github.com/improbable-eng/ts-protoc-gen">ts-protoc-gen</a></h4>
<pre>$ <span class="hljs-built_in">npm</span> i --save-dev ts-protoc-gen @improbable-eng/grpc-web
</pre>
<h4 id="-2-3-protoc-https-github-com-protocolbuffers-protobuf-releases-">步骤 2.3。 安装代码生成器插件 <a href="https://github.com/protocolbuffers/protobuf/releases">protoc</a></h4>
<pre><span class="hljs-variable">$ </span>PROTOC_ZIP=protoc-<span class="hljs-number">22.2</span>-osx-x86_64.zip
<span class="hljs-variable">$ </span>curl -OL <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/protocolbuffers</span><span class="hljs-regexp">/protobuf/releases</span><span class="hljs-regexp">/download/v</span>22.<span class="hljs-number">2</span>/<span class="hljs-variable">$PROTOC_ZIP</span>
<span class="hljs-variable">$ </span>sudo unzip -o <span class="hljs-variable">$PROTOC_ZIP</span> -d /usr/local bin/protoc
<span class="hljs-variable">$ </span>sudo unzip -o <span class="hljs-variable">$PROTOC_ZIP</span> -d /usr/local <span class="hljs-string">'include/*'</span>
<span class="hljs-variable">$ </span>rm -f <span class="hljs-variable">$PROTOC_ZIP</span>
</pre>
<p>也可以使用如下命令安装（macOS）：</p>
<pre>$ <span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>protobuf
</pre>
<p>安装完成后查看版本</p>
<pre>$ protoc <span class="hljs-comment">--version</span>
</pre>
<h4 id="-2-4-protoc-gen-js-https-www-npmjs-com-package-protoc-gen-js-protoc-gen-grpc-web-https-www-npmjs-com-package-protoc-gen-grpc-web-">步骤 2.4。 继续安装插件 <a href="https://www.npmjs.com/package/protoc-gen-js">protoc-gen-js</a> 和 <a href="https://www.npmjs.com/package/protoc-gen-grpc-web">protoc-gen-grpc-web</a></h4>
<pre>$ sudo npm i -<span class="hljs-keyword">g</span> protoc-<span class="hljs-keyword">gen</span>-js protoc-<span class="hljs-keyword">gen</span>-grpc-web
</pre>
<h4 id="-2-5-">步骤 2.5。 编译执行</h4>
<p>运行以下命令编译<code>.proto</code>文件，生成我们可以识别的<code>.js</code>文件。</p>
<pre>$ npm <span class="hljs-keyword">run</span><span class="bash"> build:protos</span>
</pre>
<p>它会生成四个文件:</p>
<ul>
<li><code>src/proto/example_pb.js</code></li>
<li><code>src/proto/example_pb.d.ts</code></li>
<li><code>src/proto/example_pb_service.js</code></li>
<li><code>src/proto/example_pb_service.d.ts</code></li>
</ul>
<hr />
<blockquote><p>可以下载<a href="https://github.com/protocolbuffers/protobuf-javascript">protobuf-javascript</a>进行测试。 教程请访问<a href="https://grpc.io/docs/platforms/web/basics/">这里</a>。</p>
<p><code>sh<br />
$ mkdir src/proto</code></p>
<p>要生成 <strong>protobuf 消息类</strong>，请运行以下命令：</p>
<p><code>sh<br />
$ protoc  --proto_path=./proto --plugin=protoc-gen-ts=./node_modules/.bin/protoc-gen-ts --js_out=import_style=commonjs,binary:src/proto --ts_out="src/proto" proto/example.proto</code></p>
<p>要生成 <strong>客户端存根</strong>，请运行以下命令：</p>
<p><code>sh<br />
$ protoc  --proto_path=./proto --plugin=protoc-gen-ts=./node_modules/.bin/protoc-gen-ts --ts_out="service=grpc-web:src/proto"  proto/example.proto</code></p></blockquote>
<h3 id="-3-">(3) 服务器入口</h3>
<p>接下来，我们在后端 gRPC 服务中使用 Node 实现我们的 <code>HelloService</code> 接口。 这将处理来自客户的请求。 教程请访问<a href="https://grpc.io/docs/platforms/web/basics/">这里</a>。</p>
<h4 id="-3-1-grpc-node-https-github-com-grpc-grpc-node-tree-master-">步骤 3.1。 安装插件 <a href="https://github.com/grpc/grpc-node/tree/master">grpc-node</a></h4>
<pre>$ <span class="hljs-built_in">npm</span> i --save-dev @grpc/grpc-js @grpc/proto-loader
</pre>
<h4 id="-3-2-src-server-index-js-">步骤 3.2。 创建文件 <code>src/server/index.js</code>：</h4>
<pre>
const path = require('path');
const grpc = require("@grpc/grpc-js");
const protoLoader = require("@grpc/proto-loader");
const PROTO_PATH = path.resolve(__dirname, '../../proto/example.proto');


const packageDefinition = protoLoader.loadSync(PROTO_PATH, {
    keepCase: true,
    longs: String,
    enums: String,
    defaults: true,
    oneofs: true,
});
const newsProto = grpc.loadPackageDefinition(packageDefinition);
/*
{
    hello: {
        HelloRequest: {
            format: 'Protocol Buffer 3 DescriptorProto',
            type: [Object],
            fileDescriptorProtos: [Array]
        },
        HelloResponse: {
            format: 'Protocol Buffer 3 DescriptorProto',
            type: [Object],
            fileDescriptorProtos: [Array]
        },
        HelloService: [class ServiceClientImpl extends Client] {
            service: [Object],
            serviceName: 'HelloService'
        }
    }
} 
*/


class gRPC extends grpc.Server {
    constructor() {
        super();
        this.addService(newsProto.hello.HelloService.service, {
            getHelloReq: this.getHelloReq
        });
    }

    /**
     * request handler.
     */
    getHelloReq(call, callback) {
        const { firstName, lastName } = call.request;

        if( firstName !== '' ) {
            callback(null, {
                greeting: `Hello: ${firstName} ${lastName}`
            });
        } else {
            callback({
                message: 'Name not found',
                code: grpc.status.INVALID_ARGUMENT
            });
        }
    }
}


function main() {
    const server = new gRPC();
    server.bindAsync(
        '127.0.0.1:9090', grpc.ServerCredentials.createInsecure(), (err, port) =&gt; {
            if (err) throw err;

            console.log(`Server running at http://127.0.0.1:${port}`);
            server.start();
        }
    );
}

main();


/*

function copyMetadata(call) { 
    const metadata = call.metadata.getMap();
    const responseMetadata = new grpc.Metadata();
    for (let key in metadata) {
        responseMetadata.set(key, metadata[key]);
    }
    return responseMetadata;
}
function getHelloReq(call, callback) { 
    const { firstName, lastName } = call.request;

    if( firstName !== '' ) {
        callback(null, {
            greeting: `Hello: ${firstName} ${lastName}`
        }, copyMetadata(call));
    } else {
        callback({
            message: 'Name not found',
            code: grpc.status.INVALID_ARGUMENT
        });
    }
}
function main() {
    const server = new grpc.Server();
    server.addService(newsProto.hello.HelloService.service, {
        getHelloReq: getHelloReq
    });
    ...
}

*/
</pre>
<h3 id="-4-">(4) 客户端入口</h3>
<p>创建文件 <code>src/client/index.js</code>：</p>
<pre>const { HelloRequest } = require('../proto/example_pb.js');
const { HelloServiceClient } = require('../proto/example_pb_service.js');


const client = new HelloServiceClient('http://' + window.location.hostname + ':12345', null, null);


function todo(str1, str2) {

    return new Promise((resolve, reject) =&gt; {
        const req = new HelloRequest();
        req.setFirstname(str1);
        req.setLastname(str2);

        client.getHelloReq(req, {}, function (err, response) {
            if (err) {
                resolve(err);
                //reject(err);
            } else {
                resolve(response.getGreeting());
            }
        });
        
    })
}

// 创建一个表单
//===================
const container = document.createElement("div");

const input1 = document.createElement("input");
input1.type = "text";
input1.id = "input1";
input1.placeholder = 'FirstName'
container.appendChild(input1);

const input2 = document.createElement("input");
input2.type = "text";
input2.id = "input2";
input2.placeholder = 'LastName'
container.appendChild(input2);

const hr = document.createElement("hr");
container.appendChild(hr);

const btn = document.createElement("button");
btn.innerHTML = "Submit";
btn.id = "btn";
container.appendChild(btn);

document.body.appendChild(container);

const $btn = document.getElementById('btn');
$btn.addEventListener('click', (e) =&gt; {
    e.preventDefault();
    main(document.getElementById('input1').value, document.getElementById('input2').value);
});


// 显示后端服务器响应的内容
//===================
async function main(str1, str2) {
    const data = await todo(str1, str2);
    console.log(data);

    const div = document.createElement("h3");
    div.innerHTML = data;
    document.body.appendChild(div);
}

</pre>
<h3 id="-5-">(5) 生成客户端文件</h3>
<p>最后，将所有这些放在一起，我们可以将所有相关的 JS 文件编译成一个可以在浏览器中使用的 JS 库。</p>
<h4 id="-5-1-">步骤 5.1。 安装依赖</h4>
<pre>$ npm i --<span class="hljs-built_in">save</span>-<span class="hljs-built_in">dev</span> webpack webpack-cli webpack-<span class="hljs-built_in">dev</span>-server html-webpack-plugin browserify google-protobuf
</pre>
<h4 id="-5-2-webpack-">步骤 5.2。 为自定义 webpack 配置创建一个文件</h4>
<p><code>build/client.config.js</code>:</p>
<pre><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> HtmlWebpackPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"html-webpack-plugin"</span>);

<span class="hljs-keyword">const</span> clientPort = process.env.PORT || <span class="hljs-number">10005</span>;
<span class="hljs-keyword">const</span> clientHost = process.env.HOST || <span class="hljs-string">'localhost'</span>;
<span class="hljs-keyword">const</span> devMode = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;

<span class="hljs-built_in">module</span>.exports = {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
    <span class="hljs-attr">performance</span>: {
        <span class="hljs-attr">hints</span>: !devMode ? <span class="hljs-string">"warning"</span> : <span class="hljs-literal">false</span>
    }, 
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-attr">fallback</span>: {
            <span class="hljs-string">"fs"</span>: <span class="hljs-literal">false</span>
          },
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.js'</span>]
    },
    <span class="hljs-attr">entry</span>: {
        <span class="hljs-string">'client-main'</span>: <span class="hljs-string">'./src/client/index.js'</span>
    },
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].js'</span>,
        <span class="hljs-attr">path</span>: path.resolve(__dirname, <span class="hljs-string">'../dist'</span>)
    },
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-keyword">new</span> HtmlWebpackPlugin({
            <span class="hljs-attr">title</span>: <span class="hljs-string">"Webpack Output"</span>,
        }),
    ],
    <span class="hljs-attr">devServer</span>: {

        <span class="hljs-comment">// Enable compression</span>
        compress: <span class="hljs-literal">false</span>,

        <span class="hljs-comment">//</span>
        host: clientHost,
        <span class="hljs-attr">port</span>: clientPort

    }
};
</pre>
<h4 id="-5-3-js-">步骤 5.3。 编译JS库</h4>
<pre>$ npm <span class="hljs-keyword">run</span><span class="bash"> build:client</span>
</pre>
<p>或者</p>
<pre><span class="hljs-comment">$</span> <span class="hljs-comment">npx</span> <span class="hljs-comment">webpack</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">progress</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">mode</span> <span class="hljs-comment">production</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">config</span> <span class="hljs-string">.</span><span class="hljs-comment">/build/client</span><span class="hljs-string">.</span><span class="hljs-comment">config</span><span class="hljs-string">.</span><span class="hljs-comment">js</span>
</pre>
<p>它将生成一个 js 文件 <code>dist/client-main.js</code> 和一个 html 文件 <code>dist/index.html</code></p>
<h4 id="-5-4-webpack-">步骤 5.4。 Webpack 服务器配置</h4>
<p>创建一个新的服务器文件 <code>server.js</code></p>
<pre><span class="hljs-keyword">const</span> Webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>);
<span class="hljs-keyword">const</span> WebpackDevServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-dev-server'</span>);
<span class="hljs-keyword">const</span> webpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./client.config.js'</span>);

<span class="hljs-keyword">const</span> compiler = Webpack(webpackConfig);
<span class="hljs-keyword">const</span> devServerOptions = { ...webpackConfig.devServer, <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span> };
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> WebpackDevServer(devServerOptions, compiler);

<span class="hljs-keyword">const</span> runServer = <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Starting server...'</span>);
  <span class="hljs-keyword">await</span> server.start();
};

runServer();
</pre>
<h3 id="-6-">(6) 部署后端服务并测试</h3>
<h4 id="-6-1-envoy-https-www-envoyproxy-io-">步骤 6.1。 安装 <a href="https://www.envoyproxy.io/">envoy</a></h4>
<p>编译 envoy 需要完整安装 Xcode.app。 仅安装命令行工具是不够的。</p>
<p>如 <strong>macOS 12.6.3</strong>，需要下载：<br />
<a href="https://developer.apple.com/services-account/download?path=/Developer_Tools/Xcode_14.2/Xcode_14.2.xip">Xcode_14.2</a></p>
<pre>$ brew <span class="hljs-keyword">update</span>
$ brew <span class="hljs-keyword">install</span> envoy
$ envoy <span class="hljs-comment">--version</span>
$ <span class="hljs-keyword">go</span> <span class="hljs-keyword">version</span>
</pre>
<blockquote>
<h6 id="-a-brew-update-brew-install-envoy-">⚠️ a) 如果运行 <code>brew update</code> 或 <code>brew install envoy</code> 出错，输入以下命令修复它：</h6>
<p><strong>macOS 或 Linux</strong></p>
<p>打开你的终端并执行</p>
<pre>$ xcode-<span class="hljs-keyword">select</span> <span class="hljs-comment">--install</span>
  $ cd /usr/<span class="hljs-keyword">local</span>/Homebrew/<span class="hljs-keyword">Library</span>/Taps/homebrew/homebrew-core/
  $ git pull
  $ brew <span class="hljs-keyword">update</span>-<span class="hljs-keyword">reset</span>
  $ brew <span class="hljs-keyword">install</span> envoy
</pre>
<h6 id="-b-go-dial-tcp-xx-xx-xx-xx-443-i-o-timeout">⚠️ b) 使用go启动服务时报错 dial tcp xx.xx.xx.xx:443: i/o timeout</h6>
<p>手动配置源</p>
<pre>$ <span class="hljs-keyword">export</span> GO111MODULE=<span class="hljs-keyword">on</span>
  $ <span class="hljs-keyword">export</span> GOPROXY=https:<span class="hljs-comment">//goproxy.cn</span>
</pre>
<p>以上配置步骤只会在当前终端生效，如何长期生效，这样就不用每次都配置环境变量了。</p>
<pre>$ <span class="hljs-keyword">echo</span> <span class="hljs-string">"export GO111MODULE=on"</span> &gt;&gt; ~/.<span class="hljs-keyword">profile</span>
  $ <span class="hljs-keyword">echo</span> <span class="hljs-string">"export GOPROXY=https://goproxy.cn"</span> &gt;&gt; ~/.<span class="hljs-keyword">profile</span>
  $ <span class="hljs-keyword">source</span> ~/.<span class="hljs-keyword">profile</span>
</pre>
<h6 id="-c-bazelisk-">⚠️ c) <code>bazelisk</code> 不支持旧版本。</h6>
<p>升级您的操作系统。</p></blockquote>
<h4 id="-6-2-envoy-">步骤 6.2。 配置 Envoy 代理</h4>
<p>创建一个新文件 <code>envoy.yaml</code>：</p>
<pre><span class="hljs-attribute">static_resources</span>:
  <span class="hljs-attribute">listeners</span>:
    - <span class="hljs-attribute">name</span>: listener_0
      <span class="hljs-attribute">address</span>:
        <span class="hljs-attribute">socket_address</span>: { <span class="hljs-attribute">address</span>: <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>, <span class="hljs-attribute">port_value</span>: <span class="hljs-number">12345</span> }
      <span class="hljs-attribute">filter_chains</span>:
        - <span class="hljs-attribute">filters</span>:
          - <span class="hljs-attribute">name</span>: envoy.filters.network.http_connection_manager
            <span class="hljs-attribute">typed_config</span>:
              <span class="hljs-string">"@type"</span>: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              <span class="hljs-attribute">codec_type</span>: auto
              <span class="hljs-attribute">stat_prefix</span>: ingress_http
              <span class="hljs-attribute">route_config</span>:
                <span class="hljs-attribute">name</span>: local_route
                <span class="hljs-attribute">virtual_hosts</span>:
                  - <span class="hljs-attribute">name</span>: local_service
                    <span class="hljs-attribute">domains</span>: [<span class="hljs-string">"*"</span>]
                    <span class="hljs-attribute">routes</span>:
                      - <span class="hljs-attribute">match</span>: { <span class="hljs-attribute">prefix</span>: <span class="hljs-string">"/"</span> }
                        <span class="hljs-attribute">route</span>:
                          <span class="hljs-attribute">cluster</span>: hello_service
                          <span class="hljs-attribute">timeout</span>: <span class="hljs-number">0s</span>
                          <span class="hljs-attribute">max_stream_duration</span>:
                            <span class="hljs-attribute">grpc_timeout_header_max</span>: <span class="hljs-number">0s</span>
                    <span class="hljs-attribute">cors</span>:
                      <span class="hljs-attribute">allow_origin_string_match</span>:
                        - <span class="hljs-attribute">prefix</span>: <span class="hljs-string">"*"</span>
                      <span class="hljs-attribute">allow_methods</span>: GET, PUT, DELETE, POST, OPTIONS
                      <span class="hljs-attribute">allow_headers</span>: keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,custom-header-<span class="hljs-number">1</span>,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout
                      <span class="hljs-attribute">max_age</span>: <span class="hljs-string">"1728000"</span>
                      <span class="hljs-attribute">expose_headers</span>: custom-header-<span class="hljs-number">1</span>,grpc-status,grpc-message
              <span class="hljs-attribute">http_filters</span>:
                - <span class="hljs-attribute">name</span>: envoy.filters.http.grpc_web
                  <span class="hljs-attribute">typed_config</span>:
                    <span class="hljs-string">"@type"</span>: type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
                - <span class="hljs-attribute">name</span>: envoy.filters.http.cors
                  <span class="hljs-attribute">typed_config</span>:
                    <span class="hljs-string">"@type"</span>: type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
                - <span class="hljs-attribute">name</span>: envoy.filters.http.router
                  <span class="hljs-attribute">typed_config</span>:
                    <span class="hljs-string">"@type"</span>: type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  <span class="hljs-attribute">clusters</span>:
    - <span class="hljs-attribute">name</span>: hello_service
      <span class="hljs-attribute">connect_timeout</span>: <span class="hljs-number">0.25s</span>
      <span class="hljs-attribute">type</span>: logical_dns
      <span class="hljs-attribute">http2_protocol_options</span>: {}
      <span class="hljs-attribute">lb_policy</span>: round_robin
      # win/mac <span class="hljs-attribute">hosts</span>: Use <span class="hljs-attribute">address</span>: host.docker.internal instead of <span class="hljs-attribute">address</span>: localhost in the line below
      <span class="hljs-attribute">load_assignment</span>:
        <span class="hljs-attribute">cluster_name</span>: cluster_0
        <span class="hljs-attribute">endpoints</span>:
          - <span class="hljs-attribute">lb_endpoints</span>:
            - <span class="hljs-attribute">endpoint</span>:
                <span class="hljs-attribute">address</span>:
                  <span class="hljs-attribute">socket_address</span>:
                    <span class="hljs-attribute">address</span>: <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
                    <span class="hljs-attribute">port_value</span>: <span class="hljs-number">9090</span>
</pre>
<blockquote><p>⚠️ 如果您在 Mac/Windows 上运行 Docker，请将最后一个地址：<code>localhost</code> 更改为</p>
<pre>    ...
    socket_address:
        <span class="hljs-selector-tag">address</span>: host<span class="hljs-selector-class">.docker</span><span class="hljs-selector-class">.internal</span>
</pre>
<p>或者如果您在 Mac 上的 Docker 版本比 v18.03.0 更早，请将其更改为：</p>
<pre>    ...
    socket_address:
        <span class="hljs-selector-tag">address</span>: docker<span class="hljs-selector-class">.for</span><span class="hljs-selector-class">.mac</span><span class="hljs-selector-class">.localhost</span>
</pre>
</blockquote>
<h4 id="-6-3-">步骤 6.3。 运行特使代理。</h4>
<p><strong>envoy.yaml</strong> 文件将 Envoy 配置为在端口 <code>12345</code> 监听浏览器请求，并将它们转发到端口 <code>9090</code>。</p>
<pre>$ npm <span class="hljs-keyword">run</span><span class="bash"> proxy</span>
</pre>
<p>or</p>
<pre><span class="hljs-variable">$ </span>envoy -c ./envoy.yaml
</pre>
<h4 id="-6-4-http-localhost-10005-">步骤 6.4。 当这些都准备好后，您可以打开浏览器选项卡并导航到 <code>http://localhost:10005</code></h4>
<ul>
<li>NodeJS gRPC 服务（端口 <code>9090</code>）</li>
<li>webpack 服务器（端口 <code>10005</code>）</li>
</ul>
<p>运行以下命令进行测试：</p>
<pre>$ npm <span class="hljs-keyword">run</span><span class="bash"> start</span>
</pre>
<p>或者</p>
<pre>$ <span class="hljs-keyword">node</span> <span class="hljs-title">./server</span>.js &amp; <span class="hljs-keyword">node</span> <span class="hljs-title">./src</span>/server/index.js
</pre>
<h4 id="-6-5-">步骤 6.5。 测试连接</h4>
<p>使用下面的命令检测：</p>
<pre>$ curl -I http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">12345</span><span class="hljs-regexp">/hello.HelloService/</span>GetHelloReq?firstName=Amy&amp;lastName=Grant
</pre>
<p>&nbsp;</p>
<p>最后，希望这篇文章对你有用，您可以下载我的开源文件包 <a href="https://github.com/xizon/grpc-getting-started" target="_blank" rel="noopener">https://github.com/xizon/grpc-getting-started</a></p>
</div><p>本文出自<a class="simple-btn" href="https://www.c945.com/article/implementation-process-of-grpc-and-front-end-applications-completely.html">没位道 - Chuckie Chang个人网站</a>，转载请保留出处，谢谢！<br/>文章采用<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC-BY-4.0"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAMAAABUFvrSAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAAEZ0FNQQAAsY58+1GTAAAAAXNSR0IB2cksfwAAAf5QTFRF////////////////8fHx7+/v6Ofn4+Pj4N/g39/f1tXV09bS0tXS0tXR0dTR0dTQ0NTQ0NPPz9PPztLOztHNzdHNzdHMz8/PzdDMzNDMzNDLzM/Ly8/Ly8/Ky87Kys3Jyc3Jyc3Iy8rLyMzIyMzHx8vHxsrGycjIxsrFxcnFyMfHxcnExMnExMjDw8jDxMfDw8fCwsfCwcXAwMXAwMW/wMS/v8S+v8O+vsO+vsK9vcK9vcK8v7+/vMG8vMG7vMC8u8C7u8C6ur+6ur+5ub65ub64uL23t7y2urm5tru1tbq0tLqztLmzs7iysrixtbW1srexsbewsLavsLWvr7Wur7SusLOvrrStrrOtr7KvrbOsrLKrr6+vq7GqrKurpqqmo6ijoqaho6Ghn6OenqCdn5+fnp2dn5aampiZlpmWlZmUmJaXk5iTkZSRkZORkY+Pj4+PiYyJjIqLjoeLh4aHhIaEhIWEgoWChIGCf4F+gICAfX98fH98fnt8en15eXx5eHV2dnN0dXJzcHJvcHBwbmxsaGVmY19hYGBgXV5dWldYUFFQUFBQQ0RDQEBAPj8+Pzs8Pzc5NTY1MjMxMjExMDAwMS0uLS0tKioqKSopKSkpKCkoKCgoKicnKCUmJCQkIx8gICAgHxscGxsbGRkZEBAQDg4ODQ4NDQwNAAAA4LK4NQAAAAN0Uk5TAAoO5yEBUwAAA+1JREFUeNq1lot3GkUUxlcviEDS7bYbKxC2oaWKSUmRpkkrSBvzIMGkJjGamoSobROtNqRVWyOppli0NBBSHxst+JiYUvr9l57dheVx8ESpncOeOfvbnW92vjv3DtyzeCqN44BIeCh02t/tcXdIDpvN4Tzs9nj9faHBcGR88u2Z2dm56H9vAIdIeCBwyudxOUWBb7FaW/YJYrvL4+sJDCjK0zOzc00pcwgPBE56j0kif3OzqCyiuHmDP+h0H/e/NhCOnJ+avjA7t55THuTWK+P2JOAwFDjpdduF2G7FoN1lwebq8gcGw2MTUzOf5IFsMpkF8le1UVf3JuAQOuV12/g0gEIqHgzGUwUA6RMvuI73hIZGxyc/fISMmYjInMEjddSlf0HA4bTvmF3RLcSNpLXFApA/YXP7+vqHIxM5pIgIUB4grwzKq2Rlo46YOjtNOgEHv0cS0oBsJr0ZZSAtOD3+wNDoGjKWsjBlsB6NruPnj4lWHj5OmHSSsdBFxhgbKRFFuPuoGANkI1Gt8vJBl7e3P/wAVTOakYtGc/iD3f8e8S+woBMzdbIf7iYYW9GIIuxx8rsoHKKaZixgl2/3+F8fQla5T0FdPmURjSL77W3GWMJkqRAyfMQ+J1pi2xpRhN1tN4E41bVF4Ibo9p0ZQJJUJzQvkopMkqgzASBhqRDDn+w3IhNjz6lEEe44sImCkSiYyWbjWneNiArYFA57e/sbCxOZEtuMbYzo5K1fgqrw87qwxBeVZQbVHZydV7uUsvjiPmdXz7lGVhCRYYksSrTul8nIxZeJFhirWOFoBa4RydgxB3cWZcjm+Z1F1YsWh8cf+lULnvbBeqhog21vI7Hw9V9lssTY6urv7NNK8OxWIKiMjGsCJbuDgNX2kj/0FTJUv90yRKbVh49XDNVkVVnAd4bKdttDePhBJUGS1Qny2UYdObKwYNFJjRXGQztxGbLSVawYfr/ZlC4FrxQ1PXhJFHmpq+fc8Jsf5AA5lZQrJedSfk+ibrc0CqRvt/ms2tEONoUOb+8b4bHJd75pqmy622KqF40S5NUzg6PjUzNNHCLg8Iqa0uZ/SunI+WaFu4+KlxsVoZjo6u7rD49NTF+Ya0oYtyThHiBXlSGzWjalL5/omAZwx7G/utAb4wXgR95+C08qjDXb/nt1RxP/4hX9HS0/oF0a0S4i1L1EtcJYcwiXqw/TmGC/UjWm9KMqldJ9zVQ1QBPGHUnkY+Xjf5kXpWofymWzeiqqmag8F1G9MH56z9l2gG+1Wlt5QWx/d6tmTJ0RZRuohtUtgdP51vWzksNud0hnr2/VxqHRF9d7XI5DA+H/+1/hM09J92+7pmyRGJsTpgAAAABJRU5ErkJggg==" alt="CC-BY-4.0"/> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p></div></div></div></section><section><div class="container"><div class="row"><div class="col-md-8 offset-md-2"><div class="blog-tags"><h6>关键词: </h6><a href="/articles/tag/index.html?page=1&amp;s=envoy">envoy</a><a href="/articles/tag/index.html?page=1&amp;s=grpc">grpc</a><a href="/articles/tag/index.html?page=1&amp;s=http2">http2</a></div></div></div></div></section><section><div class="container"><div class="row"><div class="col-md-8 offset-md-2"><div class="row justify-content-between pb-5"><div class="col text-start"><a class="simple-btn" href="/article/year-end-summary-2022.html"><i class="fas fa-long-arrow-alt-left"></i>  上一篇</a></div></div><hr/><div class="text-center p-3"><a class="axil-btn btn-fill-primary" href="/article/[id]"><span>返回列表</span></a>  <a class="axil-btn btn-fill-secondary" data-title="gRPC与前端应用的完整实现过程" data-url="https://www.c945.com/article/implementation-process-of-grpc-and-front-end-applications-completely.html" data-pic="https://www.c945.com/static-remote/files/medium-blog-cover-1200x771-grpc-770x340-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg" href="#" data-modal-width="600px" data-modal-height="300px"><svg viewBox="0 0 448 512"><path fill="#0d6efd" d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"></path></svg>分享</a><div class="styles_app-share-modal-box__9M8_R"><a href="#" class="styles_app-share-modal-box__close__gDukx"><svg xmlns="http://www.w3.org/2000/svg" width="20" viewBox="0 0 320 512"><path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"></path></svg></a><div class="styles_app-share-modal-box__content__7Z_58"><div><div class="styles_app-share__wrapper__xvEL0"><h3>分享给朋友!</h3><div><span data-network="true" data-title="gRPC与前端应用的完整实现过程" data-url="https://www.c945.com/article/implementation-process-of-grpc-and-front-end-applications-completely.html" data-pic="https://www.c945.com/static-remote/files/medium-blog-cover-1200x771-grpc-770x340-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg" data-href="https://tool.oschina.net/action/qrcode/generate?data={u}&amp;output=image%2Fgif&amp;error=L&amp;type=0&amp;margin=0&amp;size=4&amp;1578559516540"><svg xmlns="http://www.w3.org/2000/svg" width="50" viewBox="0 0 576 512"><path fill="#0c7f3a" d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154zm-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4zm-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2zM563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4zm-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6zm107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6z"></path></svg></span><em>微信</em></div><div><span data-network="true" data-title="gRPC与前端应用的完整实现过程" data-url="https://www.c945.com/article/implementation-process-of-grpc-and-front-end-applications-completely.html" data-pic="https://www.c945.com/static-remote/files/medium-blog-cover-1200x771-grpc-770x340-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg" data-href="http://service.weibo.com/share/share.php?title={t}&amp;url={u}&amp;pic={p}"><svg xmlns="http://www.w3.org/2000/svg" width="50" viewBox="0 0 576 512"><path fill="#d90909" d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"></path></svg></span><em>微博</em></div></div></div></div></div></div></div></div></div></section><section class="pb--80 pb_lg--40 pb_md--20"><div class="container"><div class="row"><div class="col-md-8 offset-md-2"><div class="blog-comment-form"><h5>文章评论</h5><hr/><div id="app-remotecomment__comments"></div><div class="app-remotecomment__form"><form id="app-remotecomment-site"><div class="row"><div class="col-lg-6"><div class="form-group"><label>标题 (必填)</label><input type="text" name="title" id="title" class="form-control"/></div></div><div class="col-lg-6"><div class="form-group"><label>电子邮箱 (必填，不公开)</label><input type="email" name="email" id="email" class="form-control"/></div></div><div class="col-lg-12"><div class="form-group"><label>网址</label><input type="url" name="url" id="url" class="form-control" placeholder="https://"/></div></div><div class="col-lg-12"><div class="form-group mb--30"><label>内容</label><textarea id="content" name="content" class="form-control textarea" cols="30" rows="4"></textarea></div></div><div class="col-lg-4 app-remotecomment-captcha-section"><div class="form-group"><label>验证码</label><input type="text" id="captcha" name="captcha" class="form-control"/></div></div><div class="col-lg-8 app-remotecomment-captcha-section"><div class="form-group"><label> </label><div class="captcha-wrapper"><span id="uix-usercenter-refresh-session-captcha"></span></div></div></div><div class="col-lg-5"><div class="form-group"><button type="submit" class="axil-btn btn-fill-primary btn-fluid" name="submit-btn">提交</button></div><p class="status"></p></div></div><input type="hidden" name="toid" id="toid" value="1021025010250100999"/><input type="hidden" name="refer" id="refer" value="https://www.c945.com/article/implementation-process-of-grpc-and-front-end-applications-completely.html"/><input type="hidden" name="app-remotecomment-site-security" id="app-remotecomment-site-security"/></form></div></div></div></div></div></section><section class="section section-padding-2 bg-color-dark pb--80 pb_lg--40"><div class="container"><div class="row"><div class="col-md-8 offset-md-2 footer-menu-link footer-menu-link--list"><h5 class="title-white">相关文章推荐</h5><ul></ul></div></div></div></section><footer class="footer-area splash-footer splash-footer--page"><div class="container"><div class="footer-bottom"><div class="row align-items-center"><div class="col-md-12 text-center"><div class="footer-copyright"><p class="copyright-text">&copy; 2010-2023 <a href="/">没位道</a> All Rights Reserved. 本站基于JAMstack技术构建<br />若未特别说明，本站所有内容均遵循<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC-BY-4.0">CC-BY-4.0 国际许可协议</a></p><script id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>
                            if (typeof(LA) !== 'undefined') LA.init({id: "JdyfUJi3RdCZVi9F",ck: "JdyfUJi3RdCZVi9F"});
                        </script></div></div></div></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"currentData":{"ID":24272785,"author":"2","author_nickname":"Matrix Flip","author_display_name":"Chuckie Chang","author_url":"","author_username":"changcheng","author_avatar":"https://secure.gravatar.com/avatar/?s=96\u0026d=mm\u0026r=g","categories":[87],"categories_output":[{"ID":87,"slug":"%e5%bc%80%e5%8f%91%e8%b6%a3%e5%91%b3","name":"开发趣味","term_taxonomy_id":87,"term_group":0,"taxonomy":"category","description":"","parent":0,"count":17}],"tags":[308,309,310],"tags_output":[{"ID":308,"slug":"envoy","name":"envoy","term_taxonomy_id":308,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":1},{"ID":309,"slug":"grpc","name":"grpc","term_taxonomy_id":309,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":1},{"ID":310,"slug":"http2","name":"http2","term_taxonomy_id":310,"term_group":0,"taxonomy":"post_tag","description":"","parent":0,"count":1}],"thumbnail":["/static-remote/files/medium-blog-cover-1200x771-grpc-770x340-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg",770,340,true],"thumbnail_mini":["/static-remote/files/medium-blog-cover-1200x771-grpc-150x150-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg",150,150,true],"thumbnail_retina":["/static-remote/files/medium-blog-cover-1200x771-grpc-1200x680-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcxjpg.jpg",1200,680,true],"thumbnail_full":["/static-remote/files/medium-blog-cover-1200x771-grpc-matrixflipcomapiwpcontentuploadsmediumblogcoverxgrpcjpg.jpg",1200,771,false],"date_day":"16","date_month":"03","date_month_e":"March","date_year":"2023","date_weekday":"Thursday","title":"gRPC与前端应用的完整实现过程","excerpt":"最近我在参与设计一个软件的架构，期间也遇到不少困难，但是只要用心去思考还是可以解决的。前端和隔离层（包括 UI层，文件管理系统，插件系统，数据处理等）的微服务基于 React + Nextjs + Nodejs + Lerna + gRPC，后端协议遵循HTTP/2的长连接及其双向通信。那么不得不说一说 gRPC。也许很多中小型项目都并未采用，它相对于REST是有一些麻烦的地方。但是鉴于大型项目的数据交互，请求与相应，也许它是一个非常好的选择。关于 gRPC 请自行去搜索相关资料了解，这篇文章主要是完整实现一个从零到一的演示。","content":"\u003cp\u003e最近我在参与设计一个软件的架构，期间也遇到不少困难，但是只要用心去思考还是可以解决的。前端和隔离层（包括 UI层，文件管理系统，插件系统，数据处理等）的微服务基于 React + Nextjs + Nodejs + Lerna + gRPC，后端协议遵循HTTP/2的长连接及其双向通信。那么不得不说一说 gRPC。也许很多中小型项目都并未采用，它相对于REST是有一些麻烦的地方。但是鉴于大型项目的数据交互，请求与相应，也许它是一个非常好的选择。关于 gRPC 请自行去搜索相关资料了解，这篇文章主要是完整实现一个从零到一的演示。\u003c/p\u003e\n\u003cp\u003e这个过程中，编译 proto 文件会用到 grpc, grpc-web 和相关的一些插件, 服务测试将使用 envoy 代理和 webpack。好了废话不多说，我们开始吧：\u003c/p\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003ch4\u003e\u003cimg class=\"alignnone size-full wp-image-24272798\" src=\"/static-remote/files/grpc-preview-matrixflipcomapiwpcontentuploadsgrpcpreviewgif.gif\" alt=\"\" width=\"1280\" height=\"720\" /\u003e\u003c/h4\u003e\n\u003ch4 id=\"-\"\u003e目录结构\u003c/h4\u003e\n\u003cpre\u003egrpc-getting-started/\r\n├── README\u003cspan class=\"hljs-selector-class\"\u003e.md\u003c/span\u003e\r\n├── LICENSE \r\n├── package\u003cspan class=\"hljs-selector-class\"\u003e.json\u003c/span\u003e\r\n├── package-lock\u003cspan class=\"hljs-selector-class\"\u003e.json\u003c/span\u003e\r\n├── envoy\u003cspan class=\"hljs-selector-class\"\u003e.yaml\u003c/span\u003e\r\n├── server\u003cspan class=\"hljs-selector-class\"\u003e.js\u003c/span\u003e\r\n├── build/          \r\n├── scripts/  \r\n├── dist/\r\n│   ├── client-main\u003cspan class=\"hljs-selector-class\"\u003e.js\u003c/span\u003e\r\n│   └── index\u003cspan class=\"hljs-selector-class\"\u003e.html\u003c/span\u003e\r\n├── proto/                \r\n│   ├── example\u003cspan class=\"hljs-selector-class\"\u003e.proto\u003c/span\u003e\r\n│   └── other\u003cspan class=\"hljs-selector-class\"\u003e.proto\u003c/span\u003e\r\n├── src/\r\n│   ├── proto/\r\n│   ├── client/\r\n│   └── server/\r\n└──\r\n\u003c/pre\u003e\n\u003ch3 id=\"-1-\"\u003e(1) 定义服务\u003c/h3\u003e\n\u003cp\u003e我们首先定义一个服务，指定可以远程调用的方法及其参数和返回类型。\u003c/p\u003e\n\u003cp\u003e这是使用在 .proto 文件中使用协议缓冲完成的，它们还用于描述有效负载消息的结构。\u003c/p\u003e\n\u003cp\u003e创建一个 proto 文件 \u003ccode\u003eproto/example.proto\u003c/code\u003e：\u003c/p\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-comment\"\u003e// 步骤 1. 基本配置\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// ================================================ ====\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// 第一行告诉编译器这个文件中使用了什么语法。\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// 第二行属于命名空间，用来防止不同的消息类型有命名冲突\u003c/span\u003e\r\n\r\nsyntax = \u003cspan class=\"hljs-string\"\u003e\"proto3\"\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003epackage\u003c/span\u003e hello;\r\n\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// 步骤 2. 定义消息结构\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// ================================================ ====\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// 这定义了请求负载。 此处进入消息的每个属性都与其类型一起定义。\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// 需要为每个属性分配一个唯一的编号，称为标签。 协议缓冲区使用此标记来表示属性，而不是使用属性名称。\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// 所以，不像 JSON 我们每次都会传递属性名称 firstName，protocol buffer 会使用数字 1 来表示 firstName。 响应负载定义类似于请求。\u003c/span\u003e\r\n\r\n\r\n\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003emessage\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eHelloRequest\u003c/span\u003e \u003c/span\u003e{\r\n    \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e firstName = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e lastName = \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\r\n}\r\n\r\n\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003emessage\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eHelloResponse\u003c/span\u003e \u003c/span\u003e{\r\n    \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e greeting = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n}\r\n\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// 步骤 3. 定义服务契约\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// ================================================ ====\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// 最后，让我们定义服务契约。 对于我们的 HelloService，我们定义了一个 GetHelloReq() 操作：\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eservice\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eHelloService\u003c/span\u003e \u003c/span\u003e{\r\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003erpc\u003c/span\u003e GetHelloReq(HelloRequest) \u003cspan class=\"hljs-keyword\"\u003ereturns\u003c/span\u003e (HelloResponse)\u003c/span\u003e;\r\n}\r\n\u003c/pre\u003e\n\u003ch3 id=\"-2-proto-js-\"\u003e(2) 生成代码 —— 将 \u003ccode\u003e.proto\u003c/code\u003e 文件编译为 \u003ccode\u003e.js\u003c/code\u003e\u003c/h3\u003e\n\u003ch4 id=\"-2-1-grpc-web-https-github-com-grpc-grpc-web-\"\u003e步骤 2.1。 安装 \u003ca href=\"https://github.com/grpc/grpc-web\"\u003egrpc-web\u003c/a\u003e 运行时库\u003c/h4\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003ecd /{your_directory}/grpc-getting-started\r\n\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003enpm i --save-dev grpc-web\r\n\u003c/pre\u003e\n\u003ch4 id=\"-2-2-typescript-ts-protoc-gen-https-github-com-improbable-eng-ts-protoc-gen-\"\u003e步骤 2.2。 安装生成 TypeScript 的插件 \u003ca href=\"https://github.com/improbable-eng/ts-protoc-gen\"\u003ets-protoc-gen\u003c/a\u003e\u003c/h4\u003e\n\u003cpre\u003e$ \u003cspan class=\"hljs-built_in\"\u003enpm\u003c/span\u003e i --save-dev ts-protoc-gen @improbable-eng/grpc-web\r\n\u003c/pre\u003e\n\u003ch4 id=\"-2-3-protoc-https-github-com-protocolbuffers-protobuf-releases-\"\u003e步骤 2.3。 安装代码生成器插件 \u003ca href=\"https://github.com/protocolbuffers/protobuf/releases\"\u003eprotoc\u003c/a\u003e\u003c/h4\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003ePROTOC_ZIP=protoc-\u003cspan class=\"hljs-number\"\u003e22.2\u003c/span\u003e-osx-x86_64.zip\r\n\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003ecurl -OL \u003cspan class=\"hljs-symbol\"\u003ehttps:\u003c/span\u003e/\u003cspan class=\"hljs-regexp\"\u003e/github.com/protocolbuffers\u003c/span\u003e\u003cspan class=\"hljs-regexp\"\u003e/protobuf/releases\u003c/span\u003e\u003cspan class=\"hljs-regexp\"\u003e/download/v\u003c/span\u003e22.\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e/\u003cspan class=\"hljs-variable\"\u003e$PROTOC_ZIP\u003c/span\u003e\r\n\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003esudo unzip -o \u003cspan class=\"hljs-variable\"\u003e$PROTOC_ZIP\u003c/span\u003e -d /usr/local bin/protoc\r\n\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003esudo unzip -o \u003cspan class=\"hljs-variable\"\u003e$PROTOC_ZIP\u003c/span\u003e -d /usr/local \u003cspan class=\"hljs-string\"\u003e'include/*'\u003c/span\u003e\r\n\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003erm -f \u003cspan class=\"hljs-variable\"\u003e$PROTOC_ZIP\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e也可以使用如下命令安装（macOS）：\u003c/p\u003e\n\u003cpre\u003e$ \u003cspan class=\"hljs-keyword\"\u003ebrew \u003c/span\u003e\u003cspan class=\"hljs-keyword\"\u003einstall \u003c/span\u003eprotobuf\r\n\u003c/pre\u003e\n\u003cp\u003e安装完成后查看版本\u003c/p\u003e\n\u003cpre\u003e$ protoc \u003cspan class=\"hljs-comment\"\u003e--version\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003ch4 id=\"-2-4-protoc-gen-js-https-www-npmjs-com-package-protoc-gen-js-protoc-gen-grpc-web-https-www-npmjs-com-package-protoc-gen-grpc-web-\"\u003e步骤 2.4。 继续安装插件 \u003ca href=\"https://www.npmjs.com/package/protoc-gen-js\"\u003eprotoc-gen-js\u003c/a\u003e 和 \u003ca href=\"https://www.npmjs.com/package/protoc-gen-grpc-web\"\u003eprotoc-gen-grpc-web\u003c/a\u003e\u003c/h4\u003e\n\u003cpre\u003e$ sudo npm i -\u003cspan class=\"hljs-keyword\"\u003eg\u003c/span\u003e protoc-\u003cspan class=\"hljs-keyword\"\u003egen\u003c/span\u003e-js protoc-\u003cspan class=\"hljs-keyword\"\u003egen\u003c/span\u003e-grpc-web\r\n\u003c/pre\u003e\n\u003ch4 id=\"-2-5-\"\u003e步骤 2.5。 编译执行\u003c/h4\u003e\n\u003cp\u003e运行以下命令编译\u003ccode\u003e.proto\u003c/code\u003e文件，生成我们可以识别的\u003ccode\u003e.js\u003c/code\u003e文件。\u003c/p\u003e\n\u003cpre\u003e$ npm \u003cspan class=\"hljs-keyword\"\u003erun\u003c/span\u003e\u003cspan class=\"bash\"\u003e build:protos\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e它会生成四个文件:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003esrc/proto/example_pb.js\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esrc/proto/example_pb.d.ts\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esrc/proto/example_pb_service.js\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esrc/proto/example_pb_service.d.ts\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr /\u003e\n\u003cblockquote\u003e\u003cp\u003e可以下载\u003ca href=\"https://github.com/protocolbuffers/protobuf-javascript\"\u003eprotobuf-javascript\u003c/a\u003e进行测试。 教程请访问\u003ca href=\"https://grpc.io/docs/platforms/web/basics/\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esh\u003cbr /\u003e\n$ mkdir src/proto\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e要生成 \u003cstrong\u003eprotobuf 消息类\u003c/strong\u003e，请运行以下命令：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esh\u003cbr /\u003e\n$ protoc  --proto_path=./proto --plugin=protoc-gen-ts=./node_modules/.bin/protoc-gen-ts --js_out=import_style=commonjs,binary:src/proto --ts_out=\"src/proto\" proto/example.proto\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e要生成 \u003cstrong\u003e客户端存根\u003c/strong\u003e，请运行以下命令：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esh\u003cbr /\u003e\n$ protoc  --proto_path=./proto --plugin=protoc-gen-ts=./node_modules/.bin/protoc-gen-ts --ts_out=\"service=grpc-web:src/proto\"  proto/example.proto\u003c/code\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch3 id=\"-3-\"\u003e(3) 服务器入口\u003c/h3\u003e\n\u003cp\u003e接下来，我们在后端 gRPC 服务中使用 Node 实现我们的 \u003ccode\u003eHelloService\u003c/code\u003e 接口。 这将处理来自客户的请求。 教程请访问\u003ca href=\"https://grpc.io/docs/platforms/web/basics/\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\n\u003ch4 id=\"-3-1-grpc-node-https-github-com-grpc-grpc-node-tree-master-\"\u003e步骤 3.1。 安装插件 \u003ca href=\"https://github.com/grpc/grpc-node/tree/master\"\u003egrpc-node\u003c/a\u003e\u003c/h4\u003e\n\u003cpre\u003e$ \u003cspan class=\"hljs-built_in\"\u003enpm\u003c/span\u003e i --save-dev @grpc/grpc-js @grpc/proto-loader\r\n\u003c/pre\u003e\n\u003ch4 id=\"-3-2-src-server-index-js-\"\u003e步骤 3.2。 创建文件 \u003ccode\u003esrc/server/index.js\u003c/code\u003e：\u003c/h4\u003e\n\u003cpre\u003e\r\nconst path = require('path');\r\nconst grpc = require(\"@grpc/grpc-js\");\r\nconst protoLoader = require(\"@grpc/proto-loader\");\r\nconst PROTO_PATH = path.resolve(__dirname, '../../proto/example.proto');\r\n\r\n\r\nconst packageDefinition = protoLoader.loadSync(PROTO_PATH, {\r\n    keepCase: true,\r\n    longs: String,\r\n    enums: String,\r\n    defaults: true,\r\n    oneofs: true,\r\n});\r\nconst newsProto = grpc.loadPackageDefinition(packageDefinition);\r\n/*\r\n{\r\n    hello: {\r\n        HelloRequest: {\r\n            format: 'Protocol Buffer 3 DescriptorProto',\r\n            type: [Object],\r\n            fileDescriptorProtos: [Array]\r\n        },\r\n        HelloResponse: {\r\n            format: 'Protocol Buffer 3 DescriptorProto',\r\n            type: [Object],\r\n            fileDescriptorProtos: [Array]\r\n        },\r\n        HelloService: [class ServiceClientImpl extends Client] {\r\n            service: [Object],\r\n            serviceName: 'HelloService'\r\n        }\r\n    }\r\n} \r\n*/\r\n\r\n\r\nclass gRPC extends grpc.Server {\r\n    constructor() {\r\n        super();\r\n        this.addService(newsProto.hello.HelloService.service, {\r\n            getHelloReq: this.getHelloReq\r\n        });\r\n    }\r\n\r\n    /**\r\n     * request handler.\r\n     */\r\n    getHelloReq(call, callback) {\r\n        const { firstName, lastName } = call.request;\r\n\r\n        if( firstName !== '' ) {\r\n            callback(null, {\r\n                greeting: `Hello: ${firstName} ${lastName}`\r\n            });\r\n        } else {\r\n            callback({\r\n                message: 'Name not found',\r\n                code: grpc.status.INVALID_ARGUMENT\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\n\r\nfunction main() {\r\n    const server = new gRPC();\r\n    server.bindAsync(\r\n        '127.0.0.1:9090', grpc.ServerCredentials.createInsecure(), (err, port) =\u0026gt; {\r\n            if (err) throw err;\r\n\r\n            console.log(`Server running at http://127.0.0.1:${port}`);\r\n            server.start();\r\n        }\r\n    );\r\n}\r\n\r\nmain();\r\n\r\n\r\n/*\r\n\r\nfunction copyMetadata(call) { \r\n    const metadata = call.metadata.getMap();\r\n    const responseMetadata = new grpc.Metadata();\r\n    for (let key in metadata) {\r\n        responseMetadata.set(key, metadata[key]);\r\n    }\r\n    return responseMetadata;\r\n}\r\nfunction getHelloReq(call, callback) { \r\n    const { firstName, lastName } = call.request;\r\n\r\n    if( firstName !== '' ) {\r\n        callback(null, {\r\n            greeting: `Hello: ${firstName} ${lastName}`\r\n        }, copyMetadata(call));\r\n    } else {\r\n        callback({\r\n            message: 'Name not found',\r\n            code: grpc.status.INVALID_ARGUMENT\r\n        });\r\n    }\r\n}\r\nfunction main() {\r\n    const server = new grpc.Server();\r\n    server.addService(newsProto.hello.HelloService.service, {\r\n        getHelloReq: getHelloReq\r\n    });\r\n    ...\r\n}\r\n\r\n*/\r\n\u003c/pre\u003e\n\u003ch3 id=\"-4-\"\u003e(4) 客户端入口\u003c/h3\u003e\n\u003cp\u003e创建文件 \u003ccode\u003esrc/client/index.js\u003c/code\u003e：\u003c/p\u003e\n\u003cpre\u003econst { HelloRequest } = require('../proto/example_pb.js');\r\nconst { HelloServiceClient } = require('../proto/example_pb_service.js');\r\n\r\n\r\nconst client = new HelloServiceClient('http://' + window.location.hostname + ':12345', null, null);\r\n\r\n\r\nfunction todo(str1, str2) {\r\n\r\n    return new Promise((resolve, reject) =\u0026gt; {\r\n        const req = new HelloRequest();\r\n        req.setFirstname(str1);\r\n        req.setLastname(str2);\r\n\r\n        client.getHelloReq(req, {}, function (err, response) {\r\n            if (err) {\r\n                resolve(err);\r\n                //reject(err);\r\n            } else {\r\n                resolve(response.getGreeting());\r\n            }\r\n        });\r\n        \r\n    })\r\n}\r\n\r\n// 创建一个表单\r\n//===================\r\nconst container = document.createElement(\"div\");\r\n\r\nconst input1 = document.createElement(\"input\");\r\ninput1.type = \"text\";\r\ninput1.id = \"input1\";\r\ninput1.placeholder = 'FirstName'\r\ncontainer.appendChild(input1);\r\n\r\nconst input2 = document.createElement(\"input\");\r\ninput2.type = \"text\";\r\ninput2.id = \"input2\";\r\ninput2.placeholder = 'LastName'\r\ncontainer.appendChild(input2);\r\n\r\nconst hr = document.createElement(\"hr\");\r\ncontainer.appendChild(hr);\r\n\r\nconst btn = document.createElement(\"button\");\r\nbtn.innerHTML = \"Submit\";\r\nbtn.id = \"btn\";\r\ncontainer.appendChild(btn);\r\n\r\ndocument.body.appendChild(container);\r\n\r\nconst $btn = document.getElementById('btn');\r\n$btn.addEventListener('click', (e) =\u0026gt; {\r\n    e.preventDefault();\r\n    main(document.getElementById('input1').value, document.getElementById('input2').value);\r\n});\r\n\r\n\r\n// 显示后端服务器响应的内容\r\n//===================\r\nasync function main(str1, str2) {\r\n    const data = await todo(str1, str2);\r\n    console.log(data);\r\n\r\n    const div = document.createElement(\"h3\");\r\n    div.innerHTML = data;\r\n    document.body.appendChild(div);\r\n}\r\n\r\n\u003c/pre\u003e\n\u003ch3 id=\"-5-\"\u003e(5) 生成客户端文件\u003c/h3\u003e\n\u003cp\u003e最后，将所有这些放在一起，我们可以将所有相关的 JS 文件编译成一个可以在浏览器中使用的 JS 库。\u003c/p\u003e\n\u003ch4 id=\"-5-1-\"\u003e步骤 5.1。 安装依赖\u003c/h4\u003e\n\u003cpre\u003e$ npm i --\u003cspan class=\"hljs-built_in\"\u003esave\u003c/span\u003e-\u003cspan class=\"hljs-built_in\"\u003edev\u003c/span\u003e webpack webpack-cli webpack-\u003cspan class=\"hljs-built_in\"\u003edev\u003c/span\u003e-server html-webpack-plugin browserify google-protobuf\r\n\u003c/pre\u003e\n\u003ch4 id=\"-5-2-webpack-\"\u003e步骤 5.2。 为自定义 webpack 配置创建一个文件\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003ebuild/client.config.js\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e path = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'path'\u003c/span\u003e);\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e HtmlWebpackPlugin = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"html-webpack-plugin\"\u003c/span\u003e);\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientPort = process.env.PORT || \u003cspan class=\"hljs-number\"\u003e10005\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientHost = process.env.HOST || \u003cspan class=\"hljs-string\"\u003e'localhost'\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e devMode = process.env.NODE_ENV !== \u003cspan class=\"hljs-string\"\u003e'production'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-built_in\"\u003emodule\u003c/span\u003e.exports = {\r\n    \u003cspan class=\"hljs-attr\"\u003emode\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'production'\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003eperformance\u003c/span\u003e: {\r\n        \u003cspan class=\"hljs-attr\"\u003ehints\u003c/span\u003e: !devMode ? \u003cspan class=\"hljs-string\"\u003e\"warning\"\u003c/span\u003e : \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\r\n    }, \r\n    \u003cspan class=\"hljs-attr\"\u003eresolve\u003c/span\u003e: {\r\n        \u003cspan class=\"hljs-attr\"\u003efallback\u003c/span\u003e: {\r\n            \u003cspan class=\"hljs-string\"\u003e\"fs\"\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\r\n          },\r\n        \u003cspan class=\"hljs-attr\"\u003eextensions\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e'.js'\u003c/span\u003e]\r\n    },\r\n    \u003cspan class=\"hljs-attr\"\u003eentry\u003c/span\u003e: {\r\n        \u003cspan class=\"hljs-string\"\u003e'client-main'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'./src/client/index.js'\u003c/span\u003e\r\n    },\r\n    \u003cspan class=\"hljs-attr\"\u003eoutput\u003c/span\u003e: {\r\n        \u003cspan class=\"hljs-attr\"\u003efilename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'[name].js'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-attr\"\u003epath\u003c/span\u003e: path.resolve(__dirname, \u003cspan class=\"hljs-string\"\u003e'../dist'\u003c/span\u003e)\r\n    },\r\n    \u003cspan class=\"hljs-attr\"\u003eplugins\u003c/span\u003e: [\r\n        \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e HtmlWebpackPlugin({\r\n            \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Webpack Output\"\u003c/span\u003e,\r\n        }),\r\n    ],\r\n    \u003cspan class=\"hljs-attr\"\u003edevServer\u003c/span\u003e: {\r\n\r\n        \u003cspan class=\"hljs-comment\"\u003e// Enable compression\u003c/span\u003e\r\n        compress: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n\r\n        \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n        host: clientHost,\r\n        \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: clientPort\r\n\r\n    }\r\n};\r\n\u003c/pre\u003e\n\u003ch4 id=\"-5-3-js-\"\u003e步骤 5.3。 编译JS库\u003c/h4\u003e\n\u003cpre\u003e$ npm \u003cspan class=\"hljs-keyword\"\u003erun\u003c/span\u003e\u003cspan class=\"bash\"\u003e build:client\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e或者\u003c/p\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-comment\"\u003e$\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003enpx\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003ewebpack\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-comment\"\u003eprogress\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-comment\"\u003emode\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003eproduction\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-literal\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-comment\"\u003econfig\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e.\u003c/span\u003e\u003cspan class=\"hljs-comment\"\u003e/build/client\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e.\u003c/span\u003e\u003cspan class=\"hljs-comment\"\u003econfig\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e.\u003c/span\u003e\u003cspan class=\"hljs-comment\"\u003ejs\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e它将生成一个 js 文件 \u003ccode\u003edist/client-main.js\u003c/code\u003e 和一个 html 文件 \u003ccode\u003edist/index.html\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"-5-4-webpack-\"\u003e步骤 5.4。 Webpack 服务器配置\u003c/h4\u003e\n\u003cp\u003e创建一个新的服务器文件 \u003ccode\u003eserver.js\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e Webpack = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'webpack'\u003c/span\u003e);\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e WebpackDevServer = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'webpack-dev-server'\u003c/span\u003e);\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e webpackConfig = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'./client.config.js'\u003c/span\u003e);\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e compiler = Webpack(webpackConfig);\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e devServerOptions = { ...webpackConfig.devServer, \u003cspan class=\"hljs-attr\"\u003eopen\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e };\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e server = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e WebpackDevServer(devServerOptions, compiler);\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e runServer = \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e () =\u0026gt; {\r\n  \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(\u003cspan class=\"hljs-string\"\u003e'Starting server...'\u003c/span\u003e);\r\n  \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e server.start();\r\n};\r\n\r\nrunServer();\r\n\u003c/pre\u003e\n\u003ch3 id=\"-6-\"\u003e(6) 部署后端服务并测试\u003c/h3\u003e\n\u003ch4 id=\"-6-1-envoy-https-www-envoyproxy-io-\"\u003e步骤 6.1。 安装 \u003ca href=\"https://www.envoyproxy.io/\"\u003eenvoy\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003e编译 envoy 需要完整安装 Xcode.app。 仅安装命令行工具是不够的。\u003c/p\u003e\n\u003cp\u003e如 \u003cstrong\u003emacOS 12.6.3\u003c/strong\u003e，需要下载：\u003cbr /\u003e\n\u003ca href=\"https://developer.apple.com/services-account/download?path=/Developer_Tools/Xcode_14.2/Xcode_14.2.xip\"\u003eXcode_14.2\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e$ brew \u003cspan class=\"hljs-keyword\"\u003eupdate\u003c/span\u003e\r\n$ brew \u003cspan class=\"hljs-keyword\"\u003einstall\u003c/span\u003e envoy\r\n$ envoy \u003cspan class=\"hljs-comment\"\u003e--version\u003c/span\u003e\r\n$ \u003cspan class=\"hljs-keyword\"\u003ego\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eversion\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003ch6 id=\"-a-brew-update-brew-install-envoy-\"\u003e⚠️ a) 如果运行 \u003ccode\u003ebrew update\u003c/code\u003e 或 \u003ccode\u003ebrew install envoy\u003c/code\u003e 出错，输入以下命令修复它：\u003c/h6\u003e\n\u003cp\u003e\u003cstrong\u003emacOS 或 Linux\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e打开你的终端并执行\u003c/p\u003e\n\u003cpre\u003e$ xcode-\u003cspan class=\"hljs-keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e--install\u003c/span\u003e\r\n  $ cd /usr/\u003cspan class=\"hljs-keyword\"\u003elocal\u003c/span\u003e/Homebrew/\u003cspan class=\"hljs-keyword\"\u003eLibrary\u003c/span\u003e/Taps/homebrew/homebrew-core/\r\n  $ git pull\r\n  $ brew \u003cspan class=\"hljs-keyword\"\u003eupdate\u003c/span\u003e-\u003cspan class=\"hljs-keyword\"\u003ereset\u003c/span\u003e\r\n  $ brew \u003cspan class=\"hljs-keyword\"\u003einstall\u003c/span\u003e envoy\r\n\u003c/pre\u003e\n\u003ch6 id=\"-b-go-dial-tcp-xx-xx-xx-xx-443-i-o-timeout\"\u003e⚠️ b) 使用go启动服务时报错 dial tcp xx.xx.xx.xx:443: i/o timeout\u003c/h6\u003e\n\u003cp\u003e手动配置源\u003c/p\u003e\n\u003cpre\u003e$ \u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e GO111MODULE=\u003cspan class=\"hljs-keyword\"\u003eon\u003c/span\u003e\r\n  $ \u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e GOPROXY=https:\u003cspan class=\"hljs-comment\"\u003e//goproxy.cn\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e以上配置步骤只会在当前终端生效，如何长期生效，这样就不用每次都配置环境变量了。\u003c/p\u003e\n\u003cpre\u003e$ \u003cspan class=\"hljs-keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"export GO111MODULE=on\"\u003c/span\u003e \u0026gt;\u0026gt; ~/.\u003cspan class=\"hljs-keyword\"\u003eprofile\u003c/span\u003e\r\n  $ \u003cspan class=\"hljs-keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"export GOPROXY=https://goproxy.cn\"\u003c/span\u003e \u0026gt;\u0026gt; ~/.\u003cspan class=\"hljs-keyword\"\u003eprofile\u003c/span\u003e\r\n  $ \u003cspan class=\"hljs-keyword\"\u003esource\u003c/span\u003e ~/.\u003cspan class=\"hljs-keyword\"\u003eprofile\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003ch6 id=\"-c-bazelisk-\"\u003e⚠️ c) \u003ccode\u003ebazelisk\u003c/code\u003e 不支持旧版本。\u003c/h6\u003e\n\u003cp\u003e升级您的操作系统。\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch4 id=\"-6-2-envoy-\"\u003e步骤 6.2。 配置 Envoy 代理\u003c/h4\u003e\n\u003cp\u003e创建一个新文件 \u003ccode\u003eenvoy.yaml\u003c/code\u003e：\u003c/p\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-attribute\"\u003estatic_resources\u003c/span\u003e:\r\n  \u003cspan class=\"hljs-attribute\"\u003elisteners\u003c/span\u003e:\r\n    - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: listener_0\r\n      \u003cspan class=\"hljs-attribute\"\u003eaddress\u003c/span\u003e:\r\n        \u003cspan class=\"hljs-attribute\"\u003esocket_address\u003c/span\u003e: { \u003cspan class=\"hljs-attribute\"\u003eaddress\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e.\u003cspan class=\"hljs-number\"\u003e0.1\u003c/span\u003e, \u003cspan class=\"hljs-attribute\"\u003eport_value\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e12345\u003c/span\u003e }\r\n      \u003cspan class=\"hljs-attribute\"\u003efilter_chains\u003c/span\u003e:\r\n        - \u003cspan class=\"hljs-attribute\"\u003efilters\u003c/span\u003e:\r\n          - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: envoy.filters.network.http_connection_manager\r\n            \u003cspan class=\"hljs-attribute\"\u003etyped_config\u003c/span\u003e:\r\n              \u003cspan class=\"hljs-string\"\u003e\"@type\"\u003c/span\u003e: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\r\n              \u003cspan class=\"hljs-attribute\"\u003ecodec_type\u003c/span\u003e: auto\r\n              \u003cspan class=\"hljs-attribute\"\u003estat_prefix\u003c/span\u003e: ingress_http\r\n              \u003cspan class=\"hljs-attribute\"\u003eroute_config\u003c/span\u003e:\r\n                \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: local_route\r\n                \u003cspan class=\"hljs-attribute\"\u003evirtual_hosts\u003c/span\u003e:\r\n                  - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: local_service\r\n                    \u003cspan class=\"hljs-attribute\"\u003edomains\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e]\r\n                    \u003cspan class=\"hljs-attribute\"\u003eroutes\u003c/span\u003e:\r\n                      - \u003cspan class=\"hljs-attribute\"\u003ematch\u003c/span\u003e: { \u003cspan class=\"hljs-attribute\"\u003eprefix\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"/\"\u003c/span\u003e }\r\n                        \u003cspan class=\"hljs-attribute\"\u003eroute\u003c/span\u003e:\r\n                          \u003cspan class=\"hljs-attribute\"\u003ecluster\u003c/span\u003e: hello_service\r\n                          \u003cspan class=\"hljs-attribute\"\u003etimeout\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0s\u003c/span\u003e\r\n                          \u003cspan class=\"hljs-attribute\"\u003emax_stream_duration\u003c/span\u003e:\r\n                            \u003cspan class=\"hljs-attribute\"\u003egrpc_timeout_header_max\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0s\u003c/span\u003e\r\n                    \u003cspan class=\"hljs-attribute\"\u003ecors\u003c/span\u003e:\r\n                      \u003cspan class=\"hljs-attribute\"\u003eallow_origin_string_match\u003c/span\u003e:\r\n                        - \u003cspan class=\"hljs-attribute\"\u003eprefix\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e\r\n                      \u003cspan class=\"hljs-attribute\"\u003eallow_methods\u003c/span\u003e: GET, PUT, DELETE, POST, OPTIONS\r\n                      \u003cspan class=\"hljs-attribute\"\u003eallow_headers\u003c/span\u003e: keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,custom-header-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout\r\n                      \u003cspan class=\"hljs-attribute\"\u003emax_age\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"1728000\"\u003c/span\u003e\r\n                      \u003cspan class=\"hljs-attribute\"\u003eexpose_headers\u003c/span\u003e: custom-header-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,grpc-status,grpc-message\r\n              \u003cspan class=\"hljs-attribute\"\u003ehttp_filters\u003c/span\u003e:\r\n                - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: envoy.filters.http.grpc_web\r\n                  \u003cspan class=\"hljs-attribute\"\u003etyped_config\u003c/span\u003e:\r\n                    \u003cspan class=\"hljs-string\"\u003e\"@type\"\u003c/span\u003e: type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb\r\n                - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: envoy.filters.http.cors\r\n                  \u003cspan class=\"hljs-attribute\"\u003etyped_config\u003c/span\u003e:\r\n                    \u003cspan class=\"hljs-string\"\u003e\"@type\"\u003c/span\u003e: type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors\r\n                - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: envoy.filters.http.router\r\n                  \u003cspan class=\"hljs-attribute\"\u003etyped_config\u003c/span\u003e:\r\n                    \u003cspan class=\"hljs-string\"\u003e\"@type\"\u003c/span\u003e: type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\r\n  \u003cspan class=\"hljs-attribute\"\u003eclusters\u003c/span\u003e:\r\n    - \u003cspan class=\"hljs-attribute\"\u003ename\u003c/span\u003e: hello_service\r\n      \u003cspan class=\"hljs-attribute\"\u003econnect_timeout\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0.25s\u003c/span\u003e\r\n      \u003cspan class=\"hljs-attribute\"\u003etype\u003c/span\u003e: logical_dns\r\n      \u003cspan class=\"hljs-attribute\"\u003ehttp2_protocol_options\u003c/span\u003e: {}\r\n      \u003cspan class=\"hljs-attribute\"\u003elb_policy\u003c/span\u003e: round_robin\r\n      # win/mac \u003cspan class=\"hljs-attribute\"\u003ehosts\u003c/span\u003e: Use \u003cspan class=\"hljs-attribute\"\u003eaddress\u003c/span\u003e: host.docker.internal instead of \u003cspan class=\"hljs-attribute\"\u003eaddress\u003c/span\u003e: localhost in the line below\r\n      \u003cspan class=\"hljs-attribute\"\u003eload_assignment\u003c/span\u003e:\r\n        \u003cspan class=\"hljs-attribute\"\u003ecluster_name\u003c/span\u003e: cluster_0\r\n        \u003cspan class=\"hljs-attribute\"\u003eendpoints\u003c/span\u003e:\r\n          - \u003cspan class=\"hljs-attribute\"\u003elb_endpoints\u003c/span\u003e:\r\n            - \u003cspan class=\"hljs-attribute\"\u003eendpoint\u003c/span\u003e:\r\n                \u003cspan class=\"hljs-attribute\"\u003eaddress\u003c/span\u003e:\r\n                  \u003cspan class=\"hljs-attribute\"\u003esocket_address\u003c/span\u003e:\r\n                    \u003cspan class=\"hljs-attribute\"\u003eaddress\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e.\u003cspan class=\"hljs-number\"\u003e0.1\u003c/span\u003e\r\n                    \u003cspan class=\"hljs-attribute\"\u003eport_value\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e9090\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cblockquote\u003e\u003cp\u003e⚠️ 如果您在 Mac/Windows 上运行 Docker，请将最后一个地址：\u003ccode\u003elocalhost\u003c/code\u003e 更改为\u003c/p\u003e\n\u003cpre\u003e    ...\r\n    socket_address:\r\n        \u003cspan class=\"hljs-selector-tag\"\u003eaddress\u003c/span\u003e: host\u003cspan class=\"hljs-selector-class\"\u003e.docker\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.internal\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e或者如果您在 Mac 上的 Docker 版本比 v18.03.0 更早，请将其更改为：\u003c/p\u003e\n\u003cpre\u003e    ...\r\n    socket_address:\r\n        \u003cspan class=\"hljs-selector-tag\"\u003eaddress\u003c/span\u003e: docker\u003cspan class=\"hljs-selector-class\"\u003e.for\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.mac\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.localhost\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"-6-3-\"\u003e步骤 6.3。 运行特使代理。\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eenvoy.yaml\u003c/strong\u003e 文件将 Envoy 配置为在端口 \u003ccode\u003e12345\u003c/code\u003e 监听浏览器请求，并将它们转发到端口 \u003ccode\u003e9090\u003c/code\u003e。\u003c/p\u003e\n\u003cpre\u003e$ npm \u003cspan class=\"hljs-keyword\"\u003erun\u003c/span\u003e\u003cspan class=\"bash\"\u003e proxy\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003eor\u003c/p\u003e\n\u003cpre\u003e\u003cspan class=\"hljs-variable\"\u003e$ \u003c/span\u003eenvoy -c ./envoy.yaml\r\n\u003c/pre\u003e\n\u003ch4 id=\"-6-4-http-localhost-10005-\"\u003e步骤 6.4。 当这些都准备好后，您可以打开浏览器选项卡并导航到 \u003ccode\u003ehttp://localhost:10005\u003c/code\u003e\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eNodeJS gRPC 服务（端口 \u003ccode\u003e9090\u003c/code\u003e）\u003c/li\u003e\n\u003cli\u003ewebpack 服务器（端口 \u003ccode\u003e10005\u003c/code\u003e）\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e运行以下命令进行测试：\u003c/p\u003e\n\u003cpre\u003e$ npm \u003cspan class=\"hljs-keyword\"\u003erun\u003c/span\u003e\u003cspan class=\"bash\"\u003e start\u003c/span\u003e\r\n\u003c/pre\u003e\n\u003cp\u003e或者\u003c/p\u003e\n\u003cpre\u003e$ \u003cspan class=\"hljs-keyword\"\u003enode\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003e./server\u003c/span\u003e.js \u0026amp; \u003cspan class=\"hljs-keyword\"\u003enode\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003e./src\u003c/span\u003e/server/index.js\r\n\u003c/pre\u003e\n\u003ch4 id=\"-6-5-\"\u003e步骤 6.5。 测试连接\u003c/h4\u003e\n\u003cp\u003e使用下面的命令检测：\u003c/p\u003e\n\u003cpre\u003e$ curl -I http:\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003elocalhost:\u003cspan class=\"hljs-number\"\u003e12345\u003c/span\u003e\u003cspan class=\"hljs-regexp\"\u003e/hello.HelloService/\u003c/span\u003eGetHelloReq?firstName=Amy\u0026amp;lastName=Grant\r\n\u003c/pre\u003e\n\u003cp\u003e\u0026nbsp;\u003c/p\u003e\n\u003cp\u003e最后，希望这篇文章对你有用，您可以下载我的开源文件包 \u003ca href=\"https://github.com/xizon/grpc-getting-started\" target=\"_blank\" rel=\"noopener\"\u003ehttps://github.com/xizon/grpc-getting-started\u003c/a\u003e\u003c/p\u003e\n","slug":"implementation-process-of-grpc-and-front-end-applications-completely","prev":[{"ID":24272756,"title":"年终2022","excerpt":"这是一封总结吗？哦也许是，也许不是。但它就是这一年的所有。我将带着从未有过的收获，跟随自己的内心，继续下一步探险。成败？有必要担心吗，生活就是一场体验，干嘛非得给自己加那么多标签，没必要，真的没必要。","slug":"year-end-summary-2022","post_date":"2022-12-27 07:45:03","post_date_gmt":"2022-12-27 07:45:03","thumbnail":[],"thumbnail_mini":[],"thumbnail_retina":[]}],"next":[],"post_date":"2023-03-16 06:30:58","post_date_gmt":"2023-03-16 06:30:58","post_status":"publish","comment_status":"open","ping_status":"open","post_password":"","to_ping":"","pinged":"","post_modified":"2023-03-20 13:24:39","post_modified_gmt":"2023-03-20 13:24:39","post_content_filtered":"","post_parent":0,"guid":"https://matrixflip.com/api/?p=24272785","menu_order":0,"post_type":"post","post_mime_type":"","comment_count":"0","filter":"raw"},"postID":"implementation-process-of-grpc-and-front-end-applications-completely"},"__N_SSG":true},"page":"/article/[id]","query":{"id":"implementation-process-of-grpc-and-front-end-applications-completely.html"},"buildId":"USGe3Qzz7MTVE_wvPjEkq","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>